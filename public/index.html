<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDT Conecte | Unified Marketing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1a233a, #0a0f1e);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-hover:hover {
            border-color: rgba(6, 182, 212, 0.4);
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-tab {
            background: rgba(6, 182, 212, 0.15);
            color: #22d3ee;
            border-left: 3px solid #22d3ee;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(34, 211, 238, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(34, 211, 238, 0.4);
        }

        .modal-full {
            max-width: 100vw !important;
            max-height: 100vh !important;
            width: 100vw !important;
            height: 100vh !important;
            border-radius: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .builder-sidebar {
            width: 320px;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.95);
        }

        .builder-workspace {
            flex: 1;
            background: #f1f5f9;
            display: flex;
            justify-content: center;
            padding: 40px;
            overflow-y: auto;
        }

        .builder-preview-container {
            background: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            transition: width 0.3s ease;
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <!-- Login Overlay -->
    <div id="loginOverlay"
        class="fixed inset-0 z-[100] bg-[#0a0f1e] flex items-center justify-center p-6 transition-all duration-500">
        <div class="glass max-w-md w-full p-8 rounded-3xl shadow-2xl relative overflow-hidden">
            <div class="absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-purple-500/20 rounded-full blur-3xl"></div>

            <div class="text-center mb-8 relative">
                <div
                    class="w-16 h-16 bg-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-cyan-500/20 mx-auto mb-4">
                    <i class="fas fa-bolt text-white text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">HDT Conecte</h1>
                <p class="text-slate-400 text-sm mt-1">Bem-vindo de volta!</p>
            </div>

            <div class="space-y-4 relative">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="email" id="loginEmail" placeholder="admin@hdt.com"
                            class="w-full bg-slate-900/50 border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white outline-none focus:border-cyan-500 transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Senha</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="password" id="loginPassword" placeholder="••••••••"
                            class="w-full bg-slate-900/50 border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white outline-none focus:border-cyan-500 transition-all">
                    </div>
                </div>
                <button onclick="handleLogin()" id="loginBtn"
                    class="w-full py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all shadow-lg shadow-cyan-600/20 flex items-center justify-center gap-2 mt-6">
                    <span>Entrar</span>
                    <i class="fas fa-arrow-right text-sm"></i>
                </button>
            </div>

            <div class="text-center mt-8 text-[10px] text-slate-600 uppercase font-bold tracking-widest">
                Protected by HDT Security
            </div>
        </div>
    </div>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 glass border-r hidden lg:flex flex-col fixed h-full z-50">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                        <i class="fas fa-bolt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-white">HDT Conecte</h1>
                        <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">Marketing Ecosystem</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-1">
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all active-tab">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </button>
                <button onclick="switchTab('gallery')" id="tab-gallery"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-images w-5"></i> HDT Gallery
                </button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Mail
                    Marketing</div>
                <button onclick="switchTab('leads')" id="tab-leads"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-users w-5"></i> Leads
                </button>
                <button onclick="switchTab('templates')" id="tab-templates"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-envelope-open-text w-5"></i> Modelos
                </button>
                <button onclick="switchTab('campaigns')" id="tab-campaigns"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-bullhorn w-5"></i> Campanhas
                </button>
                <button onclick="switchTab('lead-capture')" id="tab-lead-capture"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-filter w-5"></i> Captura de Leads
                </button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">System</div>
                <button onclick="switchTab('settings')" id="tab-settings"
                    class="admin-only w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5 hidden">
                    <i class="fas fa-cog w-5"></i> Configurações
                </button>
            </nav>

            <div class="mt-auto p-4 border-t border-white/5 relative">
                <!-- User Profile & Dropdown -->
                <div class="relative group">
                    <button onclick="toggleUserDropdown(event)"
                        class="w-full flex items-center gap-3 p-3 mb-2 rounded-2xl transition-all hover:bg-white/5 border border-transparent hover:border-white/10 group">
                        <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-cyan-400 border border-white/10 overflow-hidden shrink-0"
                            id="userAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <p class="text-sm font-bold text-white truncate" id="userNameDisplay">Usuário</p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider truncate"
                                id="userRoleDisplay">Papel</p>
                        </div>
                        <i
                            class="fas fa-chevron-up text-[10px] text-slate-500 group-hover:text-cyan-400 transition-colors"></i>
                    </button>

                    <!-- User Dropdown Menu -->
                    <div id="userDropdown"
                        class="hidden absolute bottom-full left-4 right-4 mb-2 bg-[#0f172a] border border-white/10 rounded-2xl shadow-2xl overflow-hidden z-[60] backdrop-blur-xl animate-in fade-in slide-in-from-bottom-2 duration-200">
                        <button onclick="openProfileModal(); toggleUserDropdown(event)"
                            class="w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-all border-b border-white/5">
                            <i class="fas fa-user-circle text-cyan-400"></i> Meu Perfil
                        </button>
                        <button onclick="handleLogout()"
                            class="w-full flex items-center gap-3 px-4 py-3 text-sm text-rose-400 hover:bg-rose-500/10 transition-all">
                            <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <div
                        class="p-4 rounded-2xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-500/20">
                        <p class="text-xs font-semibold text-white">Self-hosted Node.js</p>
                        <p class="text-[10px] text-slate-400 mt-1">v2.0 Beta - Optimized</p>
                    </div>
                </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 p-4 lg:p-8">

            <!-- Dashboard Section -->
            <section id="section-dashboard" class="space-y-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                        <p class="text-slate-400">Bem-vindo ao centro de comando da HDT ENERGY.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center text-blue-400">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Total Leads</p>
                        <h3 id="stat-leads" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-cyan-500/20 rounded-2xl flex items-center justify-center text-cyan-400">
                                <i class="fas fa-paper-plane text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Emails Enviados</p>
                        <h3 id="stat-sent" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-purple-500/20 rounded-2xl flex items-center justify-center text-purple-400">
                                <i class="fas fa-file-image text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Imagens na Galeria</p>
                        <h3 id="stat-images" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-amber-500/20 rounded-2xl flex items-center justify-center text-amber-400">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Campanhas Ativas</p>
                        <h3 id="stat-active-camp" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-rose-500/20 rounded-2xl flex items-center justify-center text-rose-400">
                                <i class="fas fa-magnifying-glass-chart text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Capturas Totais</p>
                        <h3 id="stat-captures" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                </div>

                <div class="glass p-8 rounded-3xl mt-8">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-xl font-bold text-white">Desempenho de Envios</h3>
                            <p class="text-sm text-slate-500">Métricas de sucesso vs falhas nos últimos disparos.</p>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Gallery Section -->
            <section id="section-gallery" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">HDT Gallery</h2>
                        <p class="text-slate-400">Links diretos para e-mails HTML.</p>
                    </div>
                    <button onclick="loadImages()"
                        class="p-3 glass rounded-xl text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- Dropzone -->
                <div id="dropzone"
                    class="glass rounded-3xl border-dashed border-2 border-slate-700 p-12 text-center relative overflow-hidden group hover:border-cyan-500/50 transition-all duration-300">
                    <input type="file" id="fileInput" accept="image/*"
                        class="opacity-0 absolute inset-0 cursor-pointer z-10">
                    <div class="flex flex-col items-center gap-4">
                        <div
                            class="w-20 h-20 bg-cyan-500/20 rounded-full flex items-center justify-center text-cyan-400 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-xl font-semibold text-white">Arraste & Solte Imagens</p>
                            <p class="text-slate-400 mt-1">PNG, JPG, GIF ou WebP (Máx 10MB)</p>
                        </div>
                    </div>
                </div>

                <div id="imageGrid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3">
                    <!-- Images will load here -->
                </div>
            </section>

            <!-- Lead Capture Section -->
            <section id="section-lead-capture" class="hidden space-y-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Captura de Leads</h2>
                        <p class="text-slate-400">Crie formulários de inscrição para capturar leads automaticamente.</p>
                    </div>
                    <button onclick="openFormWizard()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition-all flex items-center gap-2 shadow-lg shadow-blue-500/20">
                        <i class="fas fa-plus"></i> Novo Formulário
                    </button>
                </div>

                <div id="formsList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Forms will load here -->
                </div>
            </section>

            <!-- Leads Section -->
            <section id="section-leads" class="hidden space-y-8">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Gestão de Leads</h2>
                        <p class="text-slate-400 font-medium">Filtre, organize e gerencie sua base de contatos.</p>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="relative flex-1 md:w-64 group">
                            <i
                                class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs group-focus-within:text-cyan-400 transition-colors"></i>
                            <input type="text" id="lead-search-input" oninput="handleLeadSearch(this.value)"
                                placeholder="Pesquisar por nome ou email..."
                                class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white outline-none focus:border-cyan-500 transition-all">
                        </div>
                        <!-- Tag Filter Search -->
                        <div class="relative flex-1 md:w-64">
                            <button onclick="toggleTagFilter()"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-slate-300 flex items-center justify-between hover:bg-white/10 transition-all">
                                <span id="tag-filter-label">Todas as Tags</span>
                                <i class="fas fa-chevron-down text-[10px] text-slate-500"></i>
                            </button>
                            <div id="tag-filter-dropdown"
                                class="absolute top-full left-0 w-full mt-2 bg-slate-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden z-50 hidden">
                                <div class="p-3 border-b border-white/5">
                                    <input type="text" placeholder="Filtrar tags..."
                                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500"
                                        oninput="searchTagsInFilter(this.value)">
                                </div>
                                <div id="tag-filter-list" class="max-h-60 overflow-y-auto p-2 space-y-1">
                                    <!-- Tags will load here -->
                                </div>
                                <div class="p-3 bg-white/5 border-t border-white/5 flex gap-2">
                                    <button onclick="clearTagFilters()"
                                        class="flex-1 py-2 text-[10px] font-bold text-slate-400 hover:text-white transition-all uppercase">Limpar</button>
                                    <button onclick="applyTagFilters()"
                                        class="flex-1 py-2 bg-cyan-600 text-white rounded-lg text-[10px] font-bold uppercase hover:bg-cyan-700 transition-all">Aplicar</button>
                                </div>
                            </div>
                        </div>

                        <input type="file" id="importInput" accept=".csv,.xlsx" class="hidden"
                            onchange="importLeads(this)">
                        <button onclick="openNewLeadModal()"
                            class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2">
                            <i class="fas fa-plus"></i> Novo Lead
                        </button>
                        <button onclick="document.getElementById('importInput').click()"
                            class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5 border-b border-white/10">
                            <tr>
                                <th class="px-6 py-4 font-bold text-slate-300">Nome</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Email</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Telefone</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Empresa</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Cidade/UF</th>
                                <th class="px-6 py-4 font-bold text-slate-300">CPF/CNPJ</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Tags</th>
                                <th class="px-6 py-4 font-bold text-slate-300 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTable" class="divide-y divide-white/5">
                            <!-- Leads here -->
                        </tbody>
                    </table>

                    <!-- Pagination Controls -->
                    <div
                        class="bg-white/5 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 border-t border-white/10">
                        <div class="flex items-center gap-4">
                            <span class="text-xs text-slate-500">Mostrar</span>
                            <select id="leads-per-page" onchange="changeRowsPerPage(this.value)"
                                class="bg-slate-900 border border-white/10 rounded-lg px-3 py-1 text-xs text-white outline-none focus:border-cyan-500 cursor-pointer">
                                <option value="50">50</option>
                                <option value="250">250</option>
                                <option value="500">500</option>
                                <option value="1000">1000</option>
                            </select>
                            <span class="text-xs text-slate-500" id="pagination-info">Mostrando 0 de 0 leads</span>
                        </div>
                        <div class="flex items-center gap-2" id="pagination-buttons">
                            <!-- Page buttons -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="section-templates" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Modelos de Email</h2>
                        <p class="text-slate-400">Crie layouts HTML impactantes.</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="templateInput" accept=".html" class="hidden"
                            onchange="uploadTemplate(this)">
                        <button onclick="document.getElementById('templateInput').click()"
                            class="px-6 py-3 bg-white/5 border border-white/10 text-white rounded-xl font-bold hover:bg-white/10 transition-all flex items-center gap-2">
                            <i class="fas fa-upload"></i> Upload HTML
                        </button>
                        <button onclick="openTemplateEditor()"
                            class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all flex items-center gap-2">
                            <i class="fas fa-plus"></i> Novo Modelo
                        </button>
                    </div>
                </div>

                <div id="templatesGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Templates here -->
                </div>
            </section>

            <!-- Campaigns Section -->
            <section id="section-campaigns" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Campanhas</h2>
                        <p class="text-slate-400">Envios em massa com controle de entrega.</p>
                    </div>
                    <button onclick="openCampaignWizard()"
                        class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all flex items-center gap-2">
                        <i class="fas fa-rocket"></i> Lançar Campanha
                    </button>
                </div>

                <div id="campaignsList" class="space-y-4">
                    <!-- Campaigns here -->
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="hidden space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">Configurações</h2>
                    <p class="text-slate-400">Configure seu servidor de e-mail e informações do remetente.</p>
                </div>

                <div class="space-y-8 max-w-4xl">
                    <!-- Informações do Remetente -->
                    <div class="glass p-8 rounded-3xl space-y-6">
                        <h3 class="text-xl font-bold text-white">Informações do Remetente</h3>
                        <p class="text-sm text-slate-400 -mt-4">Como você aparecerá para os destinatários.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Nome do Remetente</label>
                                <input type="text" id="set-name" placeholder="HDT Energy | No-Reply"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Email do Remetente</label>
                                <input type="email" id="set-email" placeholder="hdt@hdt.energy"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/5">
                            <label class="block text-sm font-bold text-slate-400 mb-2">Base URL do Sistema (para
                                rastreamento)</label>
                            <input type="text" id="set-baseUrl" placeholder="https://marketing.hdt.energy"
                                class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            <p class="text-[10px] text-slate-500 mt-2">Usado para links de clique e pixels de
                                visualização nos e-mails.</p>
                        </div>
                    </div>

                    <!-- Método de Envio -->
                    <div class="glass p-8 rounded-3xl space-y-6">
                        <h3 class="text-xl font-bold text-white">Método de Envio</h3>
                        <p class="text-sm text-slate-400 -mt-4">Escolha como os e-mails serão enviados.</p>

                        <div class="space-y-4">
                            <label
                                class="flex items-center gap-4 p-4 bg-slate-900/50 border border-white/10 rounded-2xl cursor-pointer hover:border-cyan-500/50 transition-all group has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/5">
                                <input type="radio" name="send-method" value="smtp" checked
                                    class="w-5 h-5 accent-cyan-500">
                                <div>
                                    <p class="font-bold text-white">SMTP Relay</p>
                                    <p class="text-xs text-slate-400">Protocolo padrão de email. Funciona com qualquer
                                        provedor (Gmail, Outlook, etc).</p>
                                </div>
                            </label>

                            <label
                                class="flex items-center gap-4 p-4 bg-slate-900/50 border border-white/10 rounded-2xl cursor-pointer hover:border-cyan-500/50 transition-all group has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/5">
                                <input type="radio" name="send-method" value="graph" class="w-5 h-5 accent-cyan-500">
                                <div>
                                    <p class="font-bold text-white">Microsoft Graph API</p>
                                    <p class="text-xs text-slate-400">Para contas Office 365. Maior entregabilidade via
                                        OAuth.</p>
                                </div>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-slate-400 mb-2">Servidor SMTP</label>
                                <input type="text" id="set-host" placeholder="smtp.office365.com"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                                <p class="text-[10px] text-slate-500 mt-2">Ex: smtp.gmail.com, smtp.office365.com</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Porta</label>
                                <input type="number" id="set-port" placeholder="587"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                                <p class="text-[10px] text-slate-500 mt-2">587 (TLS) ou 465 (SSL)</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Segurança (SSL/TLS)</label>
                                <select id="set-forceSecure"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                                    <option value="auto">Automático (Padrão)</option>
                                    <option value="true">Forçar SSL/TLS (Implicit)</option>
                                    <option value="false">Desativar SSL Direto (STARTTLS)</option>
                                </select>
                                <p class="text-[10px] text-slate-500 mt-2">Padrão: Porta 465 usa SSL, 587 usa STARTTLS.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Certificado SSL</label>
                                <label
                                    class="flex items-center gap-3 p-3 bg-slate-900/50 border border-white/10 rounded-xl cursor-pointer hover:border-cyan-500/50 transition-all">
                                    <input type="checkbox" id="set-ignoreCert" class="w-4 h-4 accent-cyan-500">
                                    <span class="text-xs text-slate-300">Ignorar erros de certificado (Inseguro)</span>
                                </label>
                                <p class="text-[10px] text-rose-400/70 mt-2 italic">Use apenas se o seu servidor SMTP
                                    tiver certificado auto-assinado ou expirado.</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Senha / Senha de
                                Aplicativo</label>
                            <input type="password" id="set-pass" placeholder="••••••••••••••••"
                                class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            <p class="text-[10px] text-slate-500 mt-2">Use senhas de aplicativo se estiver usando Gmail
                                ou Outlook.</p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="saveConfig()"
                            class="px-8 py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all">Salvar
                            Configuração</button>
                        <button onclick="testSmtp()"
                            class="px-8 py-4 bg-transparent border-2 border-white/20 text-white rounded-xl font-bold hover:bg-white/5 transition-all flex items-center gap-2">
                            <i class="far fa-check-circle"></i> Testar Conexão
                        </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals (Leads, Editor, etc) -->
    <div id="modalOverlay"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden items-center justify-center">
        <div id="modalContent" class="glass w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-y-auto p-8 relative">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-8 right-8 glass p-4 rounded-2xl flex items-center gap-4 transition-all duration-500 translate-y-32 z-[200]">
        <div id="toastIconBg" class="p-2 rounded-lg">
            <i id="toastIcon" class="fas text-sm"></i>
        </div>
        <p id="toastMsg" class="font-semibold text-white"></p>
    </div>

    <script>
        // Core state
        let currentTab = 'dashboard';
        const sections = ['dashboard', 'gallery', 'leads', 'templates', 'campaigns', 'lead-capture', 'settings'];

        // --- Auth ---
        let currentUser = JSON.parse(localStorage.getItem('hdt_user') || 'null');

        function checkAuth() {
            // Check if it's a public form URL
            if (window.location.pathname.startsWith('/f/')) {
                const formId = window.location.pathname.split('/')[2];
                renderPublicForm(formId);
                return;
            }

            if (!currentUser) {
                document.getElementById('loginOverlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('loginOverlay').classList.add('flex');
            } else {
                document.getElementById('loginOverlay').classList.add('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('loginOverlay').classList.remove('flex');
                applyRBAC();
                updateUserDisplay();
            }
        }

        function applyRBAC() {
            const adminOnly = document.querySelectorAll('.admin-only');
            adminOnly.forEach(el => {
                if (currentUser && currentUser.role === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function updateUserDisplay() {
            const nameEl = document.getElementById('userNameDisplay');
            const roleEl = document.getElementById('userRoleDisplay');
            const avatarEl = document.getElementById('userAvatar');
            if (currentUser && nameEl && roleEl) {
                nameEl.innerText = currentUser.name;
                roleEl.innerText = currentUser.role === 'admin' ? 'Administrador' : 'Usuário';
                if (avatarEl) {
                    if (currentUser.avatar) {
                        avatarEl.innerHTML = `<img src="${currentUser.avatar}" class="w-full h-full object-cover">`;
                    } else {
                        avatarEl.innerHTML = `<i class="fas fa-user"></i>`;
                    }
                }
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            if (!email || !password) return showToast('Preencha os campos', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('hdt_user', JSON.stringify(currentUser));
                    showToast(`Bem-vindo, ${currentUser.name}!`);
                    checkAuth();
                    loadDashboard();
                } else {
                    showToast(data.error || 'Erro no login', 'error');
                }
            } catch (err) {
                showToast('Erro ao conectar ao servidor', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Entrar</span> <i class="fas fa-arrow-right text-sm"></i>';
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('hdt_user');
            checkAuth();
        }

        // --- Navigation ---
        function switchTab(tabId) {
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                const t = document.getElementById(`tab-${s}`);
                if (t) t.classList.remove('active-tab', 'bg-white/5', 'text-cyan-400');
            });

            // Close tag filter dropdown when switching tabs
            document.getElementById('tag-filter-dropdown').classList.add('hidden');

            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) activeTab.classList.add('active-tab');

            currentTab = tabId;

            // Auto refresh content
            if (tabId === 'gallery') loadImages();
            if (tabId === 'leads') loadLeads();
            if (tabId === 'templates') loadTemplates();
            if (tabId === 'campaigns') loadCampaigns();
            if (tabId === 'lead-capture') loadForms();
            if (tabId === 'settings') loadConfig();
            if (tabId === 'dashboard') loadStats();
        }

        // --- Notifications ---
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            const toastIconBg = document.getElementById('toastIconBg');
            const toastIcon = document.getElementById('toastIcon');

            toastMsg.innerText = msg;
            toast.classList.remove('translate-y-32');

            toastIconBg.className = 'p-2 rounded-lg';
            toastIcon.className = 'fas text-sm';

            if (type === 'error') {
                toastIconBg.classList.add('bg-rose-500/20');
                toastIcon.classList.add('fa-times', 'text-rose-400');
            } else if (type === 'info') {
                toastIconBg.classList.add('bg-cyan-500/20');
                toastIcon.classList.add('fa-spinner', 'fa-spin', 'text-cyan-400');
            } else {
                toastIconBg.classList.add('bg-cyan-500/20');
                toastIcon.classList.add('fa-check', 'text-cyan-400');
            }

            setTimeout(() => { toast.classList.add('translate-y-32'); }, 4000);
        }

        // --- Gallery ---
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const images = await response.json();
                const grid = document.getElementById('imageGrid');
                grid.innerHTML = images.map(img => `
                    <div class="glass p-2 rounded-2xl glass-hover group">
                        <div class="aspect-square rounded-xl overflow-hidden bg-slate-800 mb-2 relative">
                            <img src="${img.url}" class="w-full h-full object-cover">
                            <button onclick="deleteImage('${img.filename}')" class="absolute top-1 right-1 p-1.5 bg-rose-500/80 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity text-[10px]">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <button onclick="copyToClipboard('${img.url}')" class="w-full py-1.5 bg-white/5 border border-white/10 rounded-lg text-[9px] font-bold hover:bg-cyan-500/10 hover:text-cyan-400 transition-all uppercase tracking-tight">
                            Link
                        </button>
                    </div>
                `).join('');
            } catch (err) { showToast('Erro ao carregar galeria', 'error'); }
        }

        async function deleteImage(filename) {
            if (!confirm('Deletar imagem?')) return;
            try {
                await fetch(`/api/images/${filename}`, { method: 'DELETE' });
                showToast('Imagem removida');
                loadImages();
            } catch (err) { showToast('Falha ao deletar', 'error'); }
        }

        // --- Leads State ---
        let allLeads = [];
        let filteredLeads = [];
        let currentPage = 1;
        let rowsPerPage = 50;
        let activeTagFilters = [];
        let tagSearchQuery = '';
        let leadSearchQuery = '';

        // Campaign Logs View State
        let currentLogs = [];
        let filteredLogs = [];
        let logPagination = { currentPage: 1, rowsPerPage: 50 };
        let activeLogFilter = 'all';

        async function loadLeads() {
            try {
                const response = await fetch('/api/marketing/leads');
                allLeads = await response.json();
                applyFilters();
            } catch (err) { showToast('Erro ao carregar leads', 'error'); }
        }

        function toggleTagFilter() {
            const dropdown = document.getElementById('tag-filter-dropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                renderTagFilterList();
            }
        }

        function searchTagsInFilter(query) {
            tagSearchQuery = query.toLowerCase();
            renderTagFilterList();
        }

        function renderTagFilterList() {
            const list = document.getElementById('tag-filter-list');
            // Get all tags and their counts
            const tagMap = {};
            allLeads.forEach(l => {
                (l.tags || []).forEach(tag => {
                    tagMap[tag] = (tagMap[tag] || 0) + 1;
                });
            });

            const tags = Object.keys(tagMap).map(name => ({
                name,
                count: tagMap[name]
            })).sort((a, b) => b.count - a.count);

            const filteredTags = tags.filter(t => t.name.toLowerCase().includes(tagSearchQuery));

            if (filteredTags.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-slate-500 text-xs">Nenhuma tag encontrada</div>';
                return;
            }

            list.innerHTML = filteredTags.map(t => `
                <label class="flex items-center justify-between p-2 hover:bg-white/5 rounded-lg cursor-pointer group transition-all">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" value="${t.name}" ${activeTagFilters.includes(t.name) ? 'checked' : ''} onchange="toggleTagInFilter('${t.name}')" class="w-4 h-4 rounded border-white/10 bg-slate-800 text-cyan-500 focus:ring-offset-0 focus:ring-cyan-500">
                        <span class="text-xs text-slate-300 group-hover:text-white">${t.name}</span>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 bg-white/5 px-2 py-0.5 rounded-full">${t.count}</span>
                </label>
            `).join('');
        }

        function toggleTagInFilter(tag) {
            if (activeTagFilters.includes(tag)) {
                activeTagFilters = activeTagFilters.filter(t => t !== tag);
            } else {
                activeTagFilters.push(tag);
            }
        }

        function clearTagFilters() {
            activeTagFilters = [];
            // Re-render list to reflect cleared state if open
            renderTagFilterList();
        }

        function applyTagFilters() {
            document.getElementById('tag-filter-dropdown').classList.add('hidden');
            const label = document.getElementById('tag-filter-label');
            if (activeTagFilters.length === 0) {
                label.innerText = 'Todas as Tags';
            } else if (activeTagFilters.length === 1) {
                label.innerText = activeTagFilters[0];
            } else {
                label.innerText = `${activeTagFilters.length} Tags Selecionadas`;
            }
            currentPage = 1;
            applyFilters();
        }

        function handleLeadSearch(query) {
            leadSearchQuery = query.toLowerCase();
            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            let tempLeads = [...allLeads];

            // Apply tag filters
            if (activeTagFilters.length > 0) {
                tempLeads = tempLeads.filter(l => (l.tags || []).some(t => activeTagFilters.includes(t)));
            }

            // Apply search query filter
            if (leadSearchQuery) {
                tempLeads = tempLeads.filter(l =>
                    (l.name && l.name.toLowerCase().includes(leadSearchQuery)) ||
                    (l.email && l.email.toLowerCase().includes(leadSearchQuery))
                );
            }

            filteredLeads = tempLeads;
            renderLeadsTable();
        }

        function renderLeadsTable() {
            const table = document.getElementById('leadsTable');
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pagedLeads = filteredLeads.slice(startIndex, endIndex);

            table.innerHTML = pagedLeads.map(l => `
                <tr>
                    <td class="px-6 py-4 text-white font-medium">${l.name || 'Sem nome'}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.email}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.telefone || '-'}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.empresa || '-'}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.cidade_uf || '-'}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.cpf_cnpj || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${(l.tags || []).map(t => `<span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-[10px] font-bold rounded-lg border border-cyan-500/20">${t}</span>`).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-1">
                            <button onclick='editLead(${JSON.stringify(l).replace(/'/g, "&apos;")})' class="text-slate-500 hover:text-cyan-400 px-2 transition-all">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLead('${l.id}')" class="text-slate-500 hover:text-rose-400 px-2 transition-all">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" class="p-12 text-center text-slate-500">Nenhum lead encontrado com esses filtros.</td></tr>';

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredLeads.length / rowsPerPage);
            const info = document.getElementById('pagination-info');
            const startRange = filteredLeads.length === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
            const endRange = Math.min(currentPage * rowsPerPage, filteredLeads.length);

            info.innerText = `Mostrando ${startRange} - ${endRange} de ${filteredLeads.length} leads`;

            const buttons = document.getElementById('pagination-buttons');
            let btnsHtml = '';

            // Prev
            btnsHtml += `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="p-2 w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-slate-400 hover:text-white disabled:opacity-20 disabled:cursor-not-allowed transition-all">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // Max visible pages logic
            const maxVisible = 5;
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);

            for (let i = start; i <= end; i++) {
                btnsHtml += `
                    <button onclick="changePage(${i})" class="w-10 h-10 rounded-xl font-bold text-xs transition-all ${i === currentPage ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'bg-white/5 border border-white/10 text-slate-400 hover:text-white'}">
                        ${i}
                    </button>
                `;
            }

            // Next
            btnsHtml += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="p-2 w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-slate-400 hover:text-white disabled:opacity-20 disabled:cursor-not-allowed transition-all">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            buttons.innerHTML = btnsHtml;
        }

        function changePage(page) {
            currentPage = page;
            renderLeadsTable();
            document.getElementById('section-leads').scrollIntoView({ behavior: 'smooth' });
        }

        function changeRowsPerPage(count) {
            rowsPerPage = parseInt(count);
            currentPage = 1;
            renderLeadsTable();
        }

        async function importLeads(input) {
            const formData = new FormData();
            formData.append('file', input.files[0]);
            showToast('Importando...', 'info');
            try {
                const res = await fetch('/api/marketing/leads/import', { method: 'POST', body: formData });
                const result = await res.json();
                showToast(`Sucesso! ${result.imported} novos, ${result.duplicates} duplicados.`);
                loadLeads();
            } catch (err) { showToast('Falha na importação', 'error'); }
            input.value = '';
        }

        async function deleteLead(id) {
            if (!confirm('Remover lead?')) return;
            await fetch(`/api/marketing/leads/${id}`, { method: 'DELETE' });
            loadLeads();
        }

        function openNewLeadModal() {
            resetModal('max-w-2xl');
            const modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">Novo Lead</h2>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nome</label>
                            <input type="text" id="new-lead-name" placeholder="Nome Completo" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email</label>
                            <input type="email" id="new-lead-email" placeholder="email@exemplo.com" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Telefone</label>
                            <input type="text" id="new-lead-phone" placeholder="(00) 00000-0000" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Empresa</label>
                            <input type="text" id="new-lead-company" placeholder="Nome da Empresa" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Cidade/UF</label>
                            <input type="text" id="new-lead-city" placeholder="Cidade - UF" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">CPF/CNPJ</label>
                            <input type="text" id="new-lead-doc" placeholder="000.000.000-00" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tags</label>
                        <div id="new-lead-tags-container" class="relative"></div>
                    </div>
                    <button onclick="saveNewLead()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-600/20">Cadastrar Lead</button>
                </div>
            `;
            initTagPicker('new-lead-tags-container');
        }

        async function saveNewLead() {
            const data = {
                name: document.getElementById('new-lead-name').value,
                email: document.getElementById('new-lead-email').value,
                telefone: document.getElementById('new-lead-phone').value,
                empresa: document.getElementById('new-lead-company').value,
                cidade_uf: document.getElementById('new-lead-city').value,
                cpf_cnpj: document.getElementById('new-lead-doc').value,
                tags: JSON.parse(document.getElementById('new-lead-tags-container').dataset.tags || '[]')
            };

            if (!data.email) return showToast('Email é obrigatório', 'error');

            try {
                const res = await fetch('/api/marketing/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Lead cadastrado com sucesso!');
                    closeModal();
                    loadLeads();
                } else {
                    showToast('Erro ao salvar lead', 'error');
                }
            } catch (err) { showToast('Erro no servidor', 'error'); }
        }

        async function editLead(lead) {
            resetModal('max-w-2xl');
            const modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">Editar Lead</h2>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <input type="hidden" id="edit-lead-id" value="${lead.id}">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nome</label>
                            <input type="text" id="edit-lead-name" value="${lead.name || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email</label>
                            <input type="email" id="edit-lead-email" value="${lead.email || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Telefone</label>
                            <input type="text" id="edit-lead-phone" value="${lead.telefone || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Empresa</label>
                            <input type="text" id="edit-lead-company" value="${lead.empresa || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Cidade/UF</label>
                            <input type="text" id="edit-lead-city" value="${lead.cidade_uf || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">CPF/CNPJ</label>
                            <input type="text" id="edit-lead-doc" value="${lead.cpf_cnpj || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tags</label>
                        <div id="edit-lead-tags-container" class="relative"></div>
                    </div>
                    <button onclick="saveLeadEdit()" class="w-full py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all shadow-lg shadow-cyan-600/20">Salvar Alterações</button>
                </div>
            `;
            initTagPicker('edit-lead-tags-container', lead.tags || []);
        }

        async function saveLeadEdit() {
            const id = document.getElementById('edit-lead-id').value;
            const data = {
                name: document.getElementById('edit-lead-name').value,
                email: document.getElementById('edit-lead-email').value,
                telefone: document.getElementById('edit-lead-phone').value,
                empresa: document.getElementById('edit-lead-company').value,
                cidade_uf: document.getElementById('edit-lead-city').value,
                cpf_cnpj: document.getElementById('edit-lead-doc').value,
                tags: JSON.parse(document.getElementById('edit-lead-tags-container').dataset.tags || '[]')
            };

            try {
                const res = await fetch(`/api/marketing/leads/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Lead atualizado!');
                    closeModal();
                    loadLeads();
                } else {
                    showToast('Erro ao atualizar lead', 'error');
                }
            } catch (err) {
                showToast('Erro no servidor', 'error');
            }
        }

        // --- Templates ---
        async function loadTemplates() {
            try {
                const response = await fetch('/api/marketing/templates');
                const templates = await response.json();
                const grid = document.getElementById('templatesGrid');
                grid.innerHTML = templates.map(t => `
                    <div class="glass p-3 rounded-3xl flex flex-col md:flex-row gap-5 border border-white/5 hover:border-cyan-500/20 transition-all group">
                        <!-- Horizontal Preview -->
                        <div class="w-full md:w-60 h-[207px] rounded-2xl overflow-hidden pointer-events-none relative flex-shrink-0">
                            <div class="w-[1000px] h-[810px] origin-top-left scale-[0.24]">
                                <iframe srcdoc="${t.htmlContent.replace(/"/g, '&quot;').replace(/{{name}}/gi, 'Cliente')}" class="w-full h-full border-0"></iframe>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-slate-950/5"></div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 flex flex-col justify-between py-1">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h4 class="text-lg font-bold text-white leading-tight line-clamp-1">${t.name}</h4>
                                    <div class="flex gap-1">
                                        <button onclick='openTemplateEditor(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="p-2 text-slate-400 hover:text-cyan-400 transition-all">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteTemplate('${t.id}')" class="p-2 text-slate-500 hover:text-rose-400 transition-all opacity-0 group-hover:opacity-100">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-[10px] text-slate-500 mt-1 line-clamp-1">Assunto: ${t.subject}</p>
                            </div>
                            
                            <div class="flex gap-2 mt-4">
                                <button onclick='copyTemplateHtml(${JSON.stringify(t.htmlContent).replace(/'/g, "&apos;")})'
                                    class="flex-1 py-2 bg-white/5 border border-white/10 rounded-xl text-[10px] font-bold text-slate-300 hover:bg-cyan-500/10 hover:text-cyan-400 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-code"></i> Copiar HTML
                                </button>
                                <button onclick='openTemplateEditor(${JSON.stringify(t).replace(/'/g, "&apos;")})'
                                    class="flex-1 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-xl text-[10px] font-bold text-cyan-400 hover:bg-cyan-500 hover:text-white transition-all">
                                    Editar Modelo
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<div class="col-span-full p-12 text-center text-slate-500">Nenhum modelo cadastrado.</div>';
            } catch (err) { }
        }

        let selectedEl = null;
        let isVisualMode = true;

        function openTemplateEditor(template = null) {
            resetModal(); // Standardize state first
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');

            modal.classList.add('modal-full');
            modal.classList.remove('p-8', 'max-w-4xl', 'max-h-[90vh]', 'rounded-3xl', 'overflow-y-auto');
            overlay.classList.add('p-0');
            overlay.classList.add('flex');
            overlay.classList.remove('hidden');

            const currentId = template ? template.id : '';
            const currentName = template ? template.name : 'Novo Modelo';
            const currentSubject = template ? template.subject : '';
            const currentHtml = template ? template.htmlContent : `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { background-color: #f4f4f5; font-family: Arial, sans-serif; margin: 0; padding: 40px; }
        .email-body { background-color: #ffffff; max-width: 600px; width: 100%; margin: 0 auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { color: #1a202c; }
        p { color: #4a5568; line-height: 1.6; }
    </style>
</head>
<body>
    <center>
        <div id="email-container" class="email-body">
            <h1 style="color: #1a202c;">Olá, {{name}}!</h1>
            <p style="color: #4a5568;">Este é o seu novo modelo de email pronto para ser editado. Use o menu lateral para customizar.</p>
        </div>
    </center>
</body>
</html>`.trim();

            modal.innerHTML = `
                <div class="flex flex-col h-screen text-slate-300">
                    <!-- Top Bar -->
                    <div class="h-16 border-b border-white/10 bg-slate-900 flex items-center justify-between px-6 shrink-0 z-50">
                        <div class="flex items-center gap-4">
                            <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-white/5 flex items-center justify-center transition-all">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h3 class="text-sm font-bold text-white">${currentName}</h3>
                                <p class="text-[10px] text-slate-500">${currentSubject || 'Sem assunto'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                             <button onclick="toggleEditorMode()" id="toggle-editor" class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold text-cyan-400 hover:bg-cyan-500/10 transition-all flex items-center gap-2">
                                <i class="fas fa-eye"></i> Preview / Código
                            </button>
                            <button onclick="saveTemplate('${currentId}')" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">
                                Salvar
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-1 overflow-hidden bg-slate-950">
                        <!-- Sidebar -->
                        <div class="builder-sidebar border-r border-white/10 flex flex-col">
                            <div class="flex-1 overflow-y-auto p-5 space-y-8">
                                <!-- Global Controls -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Informações</label>
                                        <div class="space-y-3">
                                            <input type="text" id="tpl-name" value="${currentName}" placeholder="Nome do Modelo" class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500 transition-all">
                                            <input type="text" id="tpl-subject" value="${currentSubject}" placeholder="Assunto do E-mail" class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500 transition-all">
                                        </div>
                                    </div>
                                </div>

                                <!-- Accordion: General Config -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between cursor-pointer group" onclick="toggleAccordion('acc-config')">
                                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest group-hover:text-white transition-all">Configuração Geral</span>
                                        <i class="fas fa-chevron-down text-[10px] transition-transform" id="icon-acc-config"></i>
                                    </div>
                                    <div id="acc-config" class="space-y-4">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-2">Fundo Geral (Body)</label>
                                            <div class="flex items-center gap-2">
                                                <input type="color" oninput="updateBodyStyle('backgroundColor', this.value)" class="w-10 h-10 rounded-lg bg-slate-800 border-0 cursor-pointer p-0 overflow-hidden">
                                                <input type="text" placeholder="#f4f4f5" class="flex-1 bg-slate-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none" oninput="updateBodyStyle('backgroundColor', this.value)">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-2">Fundo do Conteúdo (Container)</label>
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2">
                                                    <input type="color" oninput="updateContainerStyle('backgroundColor', this.value)" class="w-8 h-8 rounded-lg bg-slate-800 border-0 cursor-pointer p-0 overflow-hidden">
                                                    <input type="text" placeholder="Cor de Fundo" class="flex-1 bg-slate-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none" oninput="updateContainerStyle('backgroundColor', this.value)">
                                                </div>
                                                <input type="text" placeholder="URL da Imagem de Fundo" class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500" oninput="updateContainerStyle('backgroundImage', 'url(' + this.value + ')')">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-2">Largura do Conteúdo</label>
                                            <div class="flex items-center gap-3">
                                                <input type="range" min="400" max="1000" value="600" class="flex-1 accent-cyan-500" oninput="updateContainerWidth(this.value)">
                                                <span id="width-val" class="text-[10px] font-bold text-white w-12 text-right">600px</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accordion: Add Blocks -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between cursor-pointer group" onclick="toggleAccordion('acc-blocks')">
                                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest group-hover:text-white transition-all">Inserir Blocos</span>
                                        <i class="fas fa-chevron-down text-[10px] transition-transform" id="icon-acc-blocks"></i>
                                    </div>
                                    <div id="acc-blocks" class="grid grid-cols-2 gap-2">
                                        <button onclick="addBlock('heading')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-heading text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Título</span>
                                        </button>
                                        <button onclick="addBlock('text')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-align-left text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Parágrafo</span>
                                        </button>
                                        <button onclick="addBlock('image')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-image text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Imagem</span>
                                        </button>
                                        <button onclick="addBlock('button')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-mouse-pointer text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Botão CTA</span>
                                        </button>
                                        <button onclick="addBlock('spacer')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-arrows-up-down text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Espaçador</span>
                                        </button>
                                        <button onclick="addBlock('divider')" class="flex flex-col items-center gap-2 p-3 bg-white/5 border border-white/5 rounded-xl hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all group">
                                            <i class="fas fa-minus text-slate-500 group-hover:text-cyan-400"></i>
                                            <span class="text-[10px] font-bold">Divisor</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Accordion: Element Style -->
                                <div id="acc-style-container" class="space-y-4 hidden">
                                    <div class="flex items-center justify-between cursor-pointer group" onclick="toggleAccordion('acc-style')">
                                        <span class="text-[11px] font-bold text-cyan-400 uppercase tracking-widest">Estilos Avançados</span>
                                        <i class="fas fa-chevron-down text-[10px] transition-transform rotate-180" id="icon-acc-style"></i>
                                    </div>
                                    <div id="acc-style" class="space-y-5">
                                        <!-- Text specific styles -->
                                        <div id="text-style-controls" class="space-y-5">
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-[10px] text-slate-500 mb-1">Tamanho Fonte</label>
                                                    <input type="number" id="style-font-size" oninput="updateElStyle('fontSize', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500">
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] text-slate-500 mb-1">Cor Texto</label>
                                                    <input type="color" id="style-font-color" oninput="updateElStyle('color', this.value)" class="w-full h-10 rounded-lg bg-slate-800 border-0 cursor-pointer p-0 overflow-hidden">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Image specific styles -->
                                        <div id="image-style-controls" class="space-y-5 hidden">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Link/URL da Imagem</label>
                                                <input type="text" id="style-img-src" oninput="updateImageUrl(this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-cyan-500">
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-[10px] text-slate-500 mb-1">Largura (%)</label>
                                                    <input type="number" id="style-img-width" oninput="updateElStyle('width', this.value + '%')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none">
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] text-slate-500 mb-1">Arredondar (px)</label>
                                                    <input type="number" id="style-img-radius" oninput="updateElStyle('borderRadius', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none">
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2 mb-3">
                                                <i class="fas fa-expand text-[9px]"></i> Espaçamento (Padding px)
                                            </label>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div class="space-y-1">
                                                    <span class="text-[9px] text-slate-600 uppercase font-bold">Cima</span>
                                                    <input type="number" id="style-pt" oninput="updateElStyle('paddingTop', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none">
                                                </div>
                                                <div class="space-y-1">
                                                    <span class="text-[9px] text-slate-600 uppercase font-bold">Baixo</span>
                                                    <input type="number" id="style-pb" oninput="updateElStyle('paddingBottom', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none">
                                                </div>
                                                <div class="space-y-1">
                                                    <span class="text-[9px] text-slate-600 uppercase font-bold">Esq</span>
                                                    <input type="number" id="style-pl" oninput="updateElStyle('paddingLeft', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none">
                                                </div>
                                                <div class="space-y-1">
                                                    <span class="text-[9px] text-slate-600 uppercase font-bold">Dir</span>
                                                    <input type="number" id="style-pr" oninput="updateElStyle('paddingRight', this.value + 'px')" class="w-full bg-slate-900 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-1 bg-slate-900 p-1 rounded-lg border border-white/5">
                                            <button onclick="updateElStyle('textAlign', 'left')" class="flex-1 py-2 rounded-md hover:bg-white/5"><i class="fas fa-align-left text-xs"></i></button>
                                            <button onclick="updateElStyle('textAlign', 'center')" class="flex-1 py-2 rounded-md hover:bg-white/5 text-cyan-400"><i class="fas fa-align-center text-xs"></i></button>
                                            <button onclick="updateElStyle('textAlign', 'right')" class="flex-1 py-2 rounded-md hover:bg-white/5"><i class="fas fa-align-right text-xs"></i></button>
                                        </div>
                                        <button onclick="deleteSelectedEl()" class="w-full py-3 bg-rose-500/10 text-rose-400 border border-rose-500/20 rounded-xl text-[10px] font-bold uppercase hover:bg-rose-500 hover:text-white transition-all">
                                            Remover Bloco
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Persistent HTML Area (Code Mode) -->
                            <div id="code-area" class="hidden h-1/2 flex flex-col border-t border-white/10 bg-slate-950">
                                <div class="bg-slate-900 p-2 flex justify-between items-center px-4">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Código HTML Fonte</span>
                                    <button onclick="toggleEditorMode()" class="text-[10px] font-bold text-rose-400 uppercase">Fechar</button>
                                </div>
                                <textarea id="tpl-html" class="flex-1 w-full bg-slate-950 p-4 text-[10px] font-mono text-cyan-500 outline-none resize-none leading-relaxed" oninput="updatePreview()">${currentHtml}</textarea>
                            </div>
                        </div>

                        <!-- Workspace -->
                        <div class="builder-workspace flex-1 overflow-y-auto p-12 flex justify-center items-start">
                            <div class="builder-preview-container w-[600px] min-h-full bg-white relative">
                                <iframe id="tpl-preview" class="w-full h-full border-0 absolute inset-0"></iframe>
                                <div id="builder-loader" class="absolute inset-0 bg-slate-900 flex items-center justify-center z-[60]">
                                    <i class="fas fa-spinner fa-spin text-cyan-400 text-3xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Variables Sidebar (Right) -->
                        <div class="w-64 border-l border-white/10 bg-slate-900/50 flex flex-col p-5 space-y-6 overflow-y-auto">
                            <div>
                                <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">Variáveis Disponíveis</h4>
                                <div class="space-y-3">
                                    <div class="p-3 glass rounded-xl border border-white/5 hover:border-cyan-500/30 transition-all cursor-pointer group" onclick="copyToClipboard('{{name}}')">
                                        <p class="text-[10px] text-slate-500 mb-1 leading-none uppercase">Nome do Lead</p>
                                        <p class="text-xs font-mono text-cyan-400 leading-none">{{name}}</p>
                                    </div>
                                    <div class="p-3 glass rounded-xl border border-white/5 hover:border-cyan-500/30 transition-all cursor-pointer group" onclick="copyToClipboard('{{email}}')">
                                        <p class="text-[10px] text-slate-500 mb-1 leading-none uppercase">E-mail do Lead</p>
                                        <p class="text-xs font-mono text-cyan-400 leading-none">{{email}}</p>
                                    </div>
                                    <div class="p-3 glass rounded-xl border border-white/5 hover:border-cyan-500/30 transition-all cursor-pointer group" onclick="copyToClipboard('{{company}}')">
                                        <p class="text-[10px] text-slate-500 mb-1 leading-none uppercase">Empresa de Lead</p>
                                        <p class="text-xs font-mono text-cyan-400 leading-none">{{company}}</p>
                                    </div>
                                    <div class="p-3 glass rounded-xl border border-white/5 hover:border-cyan-500/30 transition-all cursor-pointer group" onclick="copyToClipboard('{{button_link}}')">
                                        <p class="text-[10px] text-slate-500 mb-1 leading-none uppercase">Link do Botão</p>
                                        <p class="text-xs font-mono text-cyan-400 leading-none">{{button_link}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-cyan-500/5 border border-cyan-500/10 rounded-2xl">
                                <p class="text-[10px] text-cyan-400 leading-relaxed"><i class="fas fa-info-circle mr-1"></i> Clique na variável para copiar e cole no texto ou links do seu e-mail.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            isVisualMode = true;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');

            setTimeout(() => {
                const iframe = document.getElementById('tpl-preview');
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.open();
                doc.write(currentHtml);
                doc.close();
                document.getElementById('builder-loader').classList.add('hidden');
                setupVisualEditor();
            }, 500);
        }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        function updateBodyStyle(prop, val) {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.body.style[prop] = val;
            syncToTextarea();
        }

        function updateContainerStyle(prop, val) {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const container = doc.getElementById('email-container');
            if (container) {
                if (prop === 'backgroundImage') {
                    container.style.backgroundSize = 'cover';
                    container.style.backgroundPosition = 'center';
                }
                container.style[prop] = val;
                syncToTextarea();
            }
        }

        function updateContainerWidth(px) {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const container = doc.getElementById('email-container');
            if (container) {
                container.style.maxWidth = px + 'px';
                document.getElementById('width-val').innerText = px + 'px';
                document.querySelector('.builder-preview-container').style.width = px + 'px';
                syncToTextarea();
            }
        }

        function updateElStyle(prop, val) {
            if (!selectedEl) return;
            selectedEl.style[prop] = val;
            syncToTextarea();
        }

        function updateImageUrl(url) {
            if (!selectedEl || selectedEl.tagName !== 'IMG') return;
            selectedEl.src = url;
            syncToTextarea();
        }

        function toggleEditorMode() {
            const codeArea = document.getElementById('code-area');
            const btn = document.getElementById('toggle-editor');
            codeArea.classList.toggle('hidden');
            if (codeArea.classList.contains('hidden')) {
                btn.innerHTML = '<i class="fas fa-eye"></i> Preview / Código';
                btn.classList.remove('text-cyan-400');
            } else {
                btn.innerHTML = '<i class="fas fa-code"></i> Modo Visual';
                btn.classList.add('text-cyan-400');
            }
        }

        function syncToTextarea() {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;

            // Clone the document to clean it up without affecting the live preview
            const clone = doc.documentElement.cloneNode(true);
            const builderStyle = clone.querySelector('#builder-styles');
            if (builderStyle) builderStyle.remove();

            let html = clone.outerHTML
                .replace(/ hdt-hover/g, '')
                .replace(/ hdt-selected/g, '')
                .replace(/ contenteditable="true"/g, '')
                .replace(/ contenteditable="false"/g, '');

            document.getElementById('tpl-html').value = html;
        }

        function addBlock(type) {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const container = doc.getElementById('email-container') || doc.body;

            let html = '';
            if (type === 'heading') html = '<h2 style="color: #1a202c; margin-top: 20px; font-size: 24px;">Título do Bloco</h2>';
            if (type === 'text') html = '<p style="color: #4a5568; line-height: 1.6; margin-top: 15px; font-size: 16px;">Novo parágrafo de texto editável. Clique aqui para alterar o conteúdo ou use o menu lateral para ajustar o estilo.</p>';
            if (type === 'image') html = '<div style="margin-top: 20px;"><img src="https://via.placeholder.com/600x300" style="width: 100%; border-radius: 8px; display: block;"></div>';
            if (type === 'button') html = '<center style="margin-top: 30px;"><a href="#" style="background-color: #06b6d4; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 50px; font-weight: bold; display: inline-block; font-size: 16px;">BOTÃO DE AÇÃO</a></center>';
            if (type === 'spacer') html = '<div style="height: 40px; width: 100%;"></div>';
            if (type === 'divider') html = '<div style="border-top: 1px solid #e2e8f0; margin: 30px 0; width: 100%;"></div>';

            const div = doc.createElement('div');
            div.innerHTML = html;
            container.appendChild(div.firstElementChild);
            syncToTextarea();
            setupVisualEditor();
        }

        function deleteSelectedEl() {
            if (selectedEl && confirm('Remover este bloco?')) {
                selectedEl.remove();
                selectedEl = null;
                document.getElementById('acc-style-container').classList.add('hidden');
                syncToTextarea();
            }
        }

        function setupVisualEditor() {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;

            const style = doc.getElementById('builder-styles') || doc.createElement('style');
            style.id = 'builder-styles';
            style.textContent = `
                .hdt-hover { outline: 2px solid rgba(6, 182, 212, 0.4) !important; outline-offset: 2px; cursor: pointer; }
                .hdt-selected { outline: 2px solid #06b6d4 !important; outline-offset: 2px; }
            `;
            if (!doc.getElementById('builder-styles')) doc.head.appendChild(style);

            doc.addEventListener('mouseover', (e) => {
                if (e.target.tagName !== 'HTML' && e.target.tagName !== 'BODY') {
                    e.target.classList.add('hdt-hover');
                }
            });

            doc.addEventListener('mouseout', (e) => {
                e.target.classList.remove('hdt-hover');
            });

            doc.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target;
                if (target.tagName !== 'HTML' && target.tagName !== 'BODY') {
                    if (selectedEl) {
                        selectedEl.classList.remove('hdt-selected');
                        selectedEl.contentEditable = "false";
                    }

                    selectedEl = target;
                    selectedEl.classList.add('hdt-selected');
                    selectedEl.contentEditable = "true";

                    document.getElementById('acc-style-container').classList.remove('hidden');
                    syncSidebarWithEl(selectedEl);
                } else {
                    if (selectedEl) {
                        selectedEl.classList.remove('hdt-selected');
                        selectedEl.contentEditable = "false";
                    }
                    selectedEl = null;
                    document.getElementById('acc-style-container').classList.add('hidden');
                }
            });

            doc.addEventListener('input', () => syncToTextarea());
        }

        function syncSidebarWithEl(el) {
            const style = window.getComputedStyle(el);

            // Toggle controls based on element type
            const isImg = el.tagName === 'IMG';
            document.getElementById('text-style-controls').classList.toggle('hidden', isImg);
            document.getElementById('image-style-controls').classList.toggle('hidden', !isImg);

            if (isImg) {
                document.getElementById('style-img-src').value = el.src || '';
                document.getElementById('style-img-width').value = parseInt(el.style.width) || 100;
                document.getElementById('style-img-radius').value = parseInt(el.style.borderRadius) || 0;
            } else {
                document.getElementById('style-font-size').value = parseInt(style.fontSize) || 16;
                const rgb = style.color.match(/\d+/g);
                if (rgb) {
                    const hex = "#" + rgb.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                    document.getElementById('style-font-color').value = hex;
                }
            }

            document.getElementById('style-pt').value = parseInt(style.paddingTop) || 0;
            document.getElementById('style-pb').value = parseInt(style.paddingBottom) || 0;
            document.getElementById('style-pl').value = parseInt(style.paddingLeft) || 0;
            document.getElementById('style-pr').value = parseInt(style.paddingRight) || 0;
        }

        function updatePreview() {
            const html = document.getElementById('tpl-html').value;
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();
            setupVisualEditor();
        }

        function resetModal(sizeClass = 'max-w-4xl') {
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');

            // Remove previous size/layout classes
            modal.classList.remove('modal-full', 'max-w-4xl', 'max-w-2xl', 'max-w-3xl', 'max-w-5xl');

            // Add default/requested classes
            modal.classList.add('p-8', 'max-h-[90vh]', 'rounded-3xl', 'overflow-y-auto', sizeClass);
            overlay.classList.remove('p-0');
            overlay.classList.add('flex');
            overlay.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('modal-full');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            selectedEl = null;

            // Optional: reset to default medium size for next open
            modal.classList.remove('p-0');
            modal.classList.add('p-8', 'max-w-4xl', 'max-h-[90vh]', 'rounded-3xl', 'overflow-y-auto');
        }

        async function saveTemplate(id = '') {
            const data = {
                name: document.getElementById('tpl-name').value,
                subject: document.getElementById('tpl-subject').value,
                htmlContent: document.getElementById('tpl-html').value
            };

            if (!data.name || !data.htmlContent) return showToast('Preencha nome e conteúdo', 'error');

            const url = id ? `/api/marketing/templates/${id}` : '/api/marketing/templates';
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Modelo salvo!');
                closeModal();
                loadTemplates();
            } catch (err) { showToast('Erro ao salvar', 'error'); }
        }

        function copyTemplateHtml(html) {
            navigator.clipboard.writeText(html).then(() => {
                showToast('HTML copiado para a área de transferência!');
            });
        }

        async function testSmtp() {
            const port = parseInt(document.getElementById('set-port').value);
            const data = {
                senderEmail: document.getElementById('set-email').value,
                senderName: document.getElementById('set-name').value,
                smtpHost: document.getElementById('set-host').value,
                smtpPort: port,
                smtpPassword: document.getElementById('set-pass').value,
                smtpIgnoreCertErrors: document.getElementById('set-ignoreCert').checked,
                smtpForceSecure: document.getElementById('set-forceSecure').value
            };

            showToast('Testando conexão...', 'info');
            try {
                const res = await fetch('/api/marketing/config/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Conexão estabelecida com sucesso!');
                } else {
                    showToast('Falha na conexão: ' + result.error, 'error');
                }
            } catch (err) {
                showToast('Erro ao testar SMTP', 'error');
            }
        }

        async function uploadTemplate(input) {
            const file = input.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            showToast('Enviando...', 'info');
            try {
                const res = await fetch('/api/marketing/templates/upload', { method: 'POST', body: formData });
                if (res.ok) {
                    showToast('Upload concluído!');
                    loadTemplates();
                } else {
                    showToast('Erro no upload', 'error');
                }
            } catch (err) { showToast('Erro no servidor', 'error'); }
            input.value = '';
        }

        async function deleteTemplate(id) {
            if (!confirm('Remover modelo?')) return;
            await fetch(`/api/marketing/templates/${id}`, { method: 'DELETE' });
            loadTemplates();
        }

        // --- Campaigns ---
        function formatCountdown(scheduledAt) {
            const diff = new Date(scheduledAt) - new Date();
            if (diff <= 0) return 'Iniciando...';
            const hours = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function loadCampaigns() {
            try {
                const response = await fetch('/api/marketing/campaigns');
                const campaigns = await response.json();
                const list = document.getElementById('campaignsList');
                list.innerHTML = campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(c => {
                    const progress = c.totalLeads ? Math.round((c.sentCount / c.totalLeads) * 100) : 0;
                    const statusColors = {
                        'pending': 'bg-slate-500/20 text-slate-400',
                        'scheduled': 'bg-purple-500/20 text-purple-400',
                        'running': 'bg-cyan-500/20 text-cyan-400',
                        'completed': 'bg-green-500/20 text-green-400',
                        'paused': 'bg-amber-500/20 text-amber-400',
                        'error': 'bg-rose-500/20 text-rose-400'
                    };

                    const isScheduled = c.status === 'scheduled';
                    const countdown = isScheduled ? `<span class="text-[10px] font-mono text-purple-400 ml-2">[ Inicia em ${formatCountdown(c.scheduledAt)} ]</span>` : '';

                    return `
                        <div class="glass p-6 rounded-3xl flex flex-col md:flex-row md:items-center justify-between gap-6 hover:border-white/10 transition-all">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-1">
                                    <h4 class="text-lg font-bold text-white">${c.name}</h4>
                                    <span class="px-2 py-0.5 rounded-full text-[10px] uppercase font-bold ${statusColors[c.status]}">${c.status}</span>
                                    ${countdown}
                                </div>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mb-4 text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                                    <span class="flex items-center gap-1"><i class="fas fa-tag text-slate-600"></i> ${c.targetTags && c.targetTags.length > 0 ? c.targetTags.join(', ') : 'Toda a Base'}</span>
                                    <span class="flex items-center gap-1"><i class="fas fa-calendar-alt text-slate-600"></i> ${new Date(c.createdAt).toLocaleDateString()}</span>
                                    <span class="flex items-center gap-1"><i class="fas fa-user text-slate-600"></i> ${c.createdBy || 'Sistema'}</span>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-end">
                                        <p class="text-xs text-slate-400 font-bold">${c.sentCount.toLocaleString()} <span class="text-slate-500 font-normal">de</span> ${c.totalLeads ? c.totalLeads.toLocaleString() : '0'} <span class="text-slate-500 font-normal ml-1">enviados</span></p>
                                        <span class="text-xs font-bold text-cyan-400">${progress}%</span>
                                    </div>
                                    <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.5)] transition-all duration-1000" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="bg-white/5 border border-white/5 rounded-xl p-2 text-center">
                                            <p class="text-[9px] text-slate-500 uppercase font-bold">Abertos</p>
                                            <p class="text-xs font-bold text-cyan-400">${c.openCount || 0}</p>
                                        </div>
                                        <div class="bg-white/5 border border-white/5 rounded-xl p-2 text-center">
                                            <p class="text-[9px] text-slate-500 uppercase font-bold">Cliques</p>
                                            <p class="text-xs font-bold text-blue-400">${c.clickCount || 0}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${c.status === 'running' ?
                            `<button onclick="stopCampaign('${c.id}')" class="px-4 py-2 bg-rose-500/20 text-rose-400 border border-rose-500/20 rounded-xl text-xs font-bold hover:bg-rose-500 hover:text-white transition-all">Parar</button>` :
                            `<button onclick="startCampaign('${c.id}', '${c.status}')" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 border border-cyan-500/20 rounded-xl text-xs font-bold hover:bg-cyan-500 hover:text-white transition-all">${c.status === 'scheduled' ? 'Antecipar' : (c.status === 'completed' ? 'Reiniciar' : 'Iniciar')}</button>`
                        }
                                <div class="w-px h-8 bg-white/5 mx-2"></div>
                                <button onclick="openLogsModal('${c.id}')" class="p-3 text-slate-500 hover:text-blue-400 hover:bg-blue-500/10 rounded-xl transition-all" title="Ver Logs da Campanha"><i class="fas fa-list-ul"></i></button>
                                ${(c.status === 'pending' || c.status === 'scheduled' || c.status === 'paused') ? `<button onclick="editCampaign('${c.id}')" class="p-3 text-slate-500 hover:text-cyan-400 hover:bg-cyan-500/10 rounded-xl transition-all" title="Editar"><i class="fas fa-edit"></i></button>` : ''}
                                <button onclick="deleteCampaign('${c.id}')" class="p-3 text-slate-500 hover:text-rose-400 hover:bg-rose-500/10 rounded-xl transition-all" title="Excluir"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('') || '<div class="p-12 text-center text-slate-500">Nenhuma campanha cadastrada.</div>';
            } catch (err) { }
        }

        // Auto refresh campaigns list for real-time progress & countdown
        setInterval(() => {
            if (currentTab === 'campaigns') loadCampaigns();
        }, 1000);

        let wizardState = { step: 1, data: {}, templates: [], leads: [], availableTags: [], selectedTags: [] };

        async function openCampaignWizard(editingId = null) {
            wizardState = { step: 1, data: { batchSize: 50, interval: 60 }, selectedTags: [], editingId };
            if (editingId) {
                const response = await fetch('/api/marketing/campaigns');
                const campaigns = await response.json();
                const campaign = campaigns.find(c => c.id === editingId);
                if (campaign) {
                    wizardState.data = { ...campaign };
                    wizardState.selectedTags = campaign.targetTags || [];
                }
            }
            wizardState.templates = await (await fetch('/api/marketing/templates')).json();
            wizardState.leads = await (await fetch('/api/marketing/leads')).json();
            renderWizard();
        }

        async function editCampaign(id) {
            openCampaignWizard(id);
        }

        function renderWizard() {
            resetModal('max-w-2xl');
            const modal = document.getElementById('modalContent');
            const step = wizardState.step;

            let content = '';
            if (step === 1) {
                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">${wizardState.editingId ? 'Editar' : 'Criar'} Campanha - Etapa 1 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Nome da Campanha</label>
                            <input type="text" id="wiz-name" value="${wizardState.data.name || ''}" placeholder="Ex: Newsletter Q3" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Assunto do Email</label>
                            <input type="text" id="wiz-subject" value="${wizardState.data.subject || ''}" placeholder="Grandes novidades..." class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Modelo de Email</label>
                            <select id="wiz-template" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                                <option value="">Selecione um modelo</option>
                                ${wizardState.templates.map(t => `<option value="${t.id}" ${wizardState.data.templateId == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="nextWizStep()" class="w-full py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all">Próximo</button>
                    </div>
                `;
            } else if (step === 2) {
                const leadCount = wizardState.selectedTags.length === 0 ? wizardState.leads.length : wizardState.leads.filter(l => l.tags.some(t => wizardState.selectedTags.includes(t))).length;

                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">${wizardState.editingId ? 'Editar' : 'Criar'} Campanha - Etapa 2 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Tags de Destino</label>
                            <p class="text-[10px] text-slate-500 mb-3">Selecione as tags dos leads que receberão esta campanha. Deixe vazio para enviar a todos.</p>
                            <div id="wiz-tags-container" class="relative"></div>
                        </div>
                        
                        <p class="text-xs text-slate-400" id="wiz-lead-count-display"><b class="text-cyan-400">${leadCount.toLocaleString()} lead(s)</b> serão incluídos nesta campanha</p>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Intervalo (segundos entre emails)</label>
                                <input type="number" id="wiz-interval" value="${wizardState.data.interval || 60}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Agendar Disparo (Opcional)</label>
                                <input type="datetime-local" id="wiz-scheduled" value="${wizardState.data.scheduledAt || ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="prevWizStep()" class="flex-1 py-4 bg-white/5 border border-white/20 text-white rounded-xl font-bold hover:bg-white/10 transition-all">Voltar</button>
                            <button onclick="nextWizStep()" class="flex-1 py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all">Revisar e Salvar</button>
                        </div>
                    </div>
                `;
            } else if (step === 3) {
                const template = wizardState.templates.find(t => t.id == wizardState.data.templateId);
                const leadCount = wizardState.selectedTags.length === 0 ? wizardState.leads.length : wizardState.leads.filter(l => l.tags.some(t => wizardState.selectedTags.includes(t))).length;

                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">${wizardState.editingId ? 'Editar' : 'Criar'} Campanha - Etapa 3 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="glass p-6 rounded-2xl bg-slate-900/50 space-y-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Nome</span>
                            <span class="text-white font-bold">${wizardState.data.name}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Assunto</span>
                            <span class="text-white font-bold">${wizardState.data.subject}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Modelo</span>
                            <span class="text-white font-bold">${template ? template.name : 'N/A'}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Controle de envio</span>
                            <span class="text-white font-bold">1 email a cada ${wizardState.data.interval}s</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Agendamento</span>
                            <span class="text-white font-bold">${wizardState.data.scheduledAt ? new Date(wizardState.data.scheduledAt).toLocaleString() : 'Imediato'}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Tags de Destino</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${wizardState.selectedTags.length > 0 ? wizardState.selectedTags.map(t => `<span class="px-2 py-0.5 bg-cyan-600 text-white rounded text-[10px] font-bold">${t}</span>`).join('') : '<span class="text-white text-xs">Todos os leads</span>'}
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/10 mt-4 flex justify-between items-end">
                            <div>
                                <span class="text-[10px] font-bold text-slate-500 uppercase">Total de Leads</span>
                                <p class="text-lg text-white font-bold">${leadCount.toLocaleString()} <span class="text-xs text-slate-500 font-normal">destinatários</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="saveCampaign()" class="flex-1 py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all shadow-lg shadow-cyan-600/20">${wizardState.editingId ? 'Atualizar' : 'Criar'} Campanha</button>
                    </div>
                `;
            }

            modal.innerHTML = content;
            if (step === 2) {
                initTagPicker('wiz-tags-container', wizardState.selectedTags, (tags) => {
                    wizardState.selectedTags = tags;
                    updateWizLeadCountUI();
                });
            }
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
        }

        function updateWizLeadCountUI() {
            const display = document.getElementById('wiz-lead-count-display');
            if (!display) return;
            const count = wizardState.selectedTags.length === 0 ?
                wizardState.leads.length :
                wizardState.leads.filter(l => (l.tags || []).some(t => wizardState.selectedTags.includes(t))).length;
            display.innerHTML = `<b class="text-cyan-400">${count.toLocaleString()} lead(s)</b> serão incluídos nesta campanha`;
        }

        function filterWizTags() {
            const query = document.getElementById('wiz-tag-search').value.toLowerCase();
            const resultsDiv = document.getElementById('wiz-tag-results');

            if (!query) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = wizardState.availableTags.filter(t => t.toLowerCase().includes(query) && !wizardState.selectedTags.includes(t));

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div class="p-4 text-slate-500 text-xs">Nenhuma tag encontrada</div>';
            } else {
                resultsDiv.innerHTML = matches.map(t => `
                    <button onclick="addWizTag('${t}')" class="w-full text-left p-3 text-sm text-white hover:bg-cyan-600 transition-all flex justify-between items-center group">
                        ${t}
                        <i class="fas fa-plus text-cyan-500 group-hover:text-white"></i>
                    </button>
                `).join('');
            }
            resultsDiv.classList.remove('hidden');
        }

        function addWizTag(tag) {
            wizardState.selectedTags.push(tag);
            document.getElementById('wiz-tag-search').value = '';
            document.getElementById('wiz-tag-results').classList.add('hidden');
            renderWizard();
        }

        function removeWizTag(tag) {
            wizardState.selectedTags = wizardState.selectedTags.filter(t => t !== tag);
            renderWizard();
        }

        function nextWizStep() {
            if (wizardState.step === 1) {
                wizardState.data.name = document.getElementById('wiz-name').value;
                wizardState.data.subject = document.getElementById('wiz-subject').value;
                wizardState.data.templateId = document.getElementById('wiz-template').value;
                if (!wizardState.data.name || !wizardState.data.templateId) return showToast('Nome e Modelo são obrigatórios', 'error');
            } else if (wizardState.step === 2) {
                wizardState.selectedTags = JSON.parse(document.getElementById('wiz-tags-container').dataset.tags || '[]');
                wizardState.data.interval = parseInt(document.getElementById('wiz-interval').value) || 60;
                wizardState.data.scheduledAt = document.getElementById('wiz-scheduled').value;
            }
            wizardState.step++;
            renderWizard();
        }

        function prevWizStep() {
            wizardState.step--;
            renderWizard();
        }

        async function saveCampaign() {
            const isEdit = !!wizardState.editingId;
            const leadCount = wizardState.selectedTags.length === 0 ?
                wizardState.leads.length :
                wizardState.leads.filter(l => (l.tags || []).some(t => wizardState.selectedTags.includes(t))).length;

            const data = {
                name: wizardState.data.name,
                templateId: wizardState.data.templateId,
                subject: wizardState.data.subject,
                targetTags: wizardState.selectedTags,
                status: wizardState.data.scheduledAt ? 'scheduled' : 'pending',
                interval: wizardState.data.interval,
                scheduledAt: wizardState.data.scheduledAt,
                totalLeads: leadCount,
                createdBy: currentUser ? currentUser.name : 'Sistema'
            };

            if (!isEdit) {
                data.sentCount = 0;
                data.failedCount = 0;
                data.createdAt = new Date();
                data.openCount = 0;
                data.clickCount = 0;
            }

            showToast(isEdit ? 'Atualizando campanha...' : 'Criando campanha...', 'info');

            const url = isEdit ? `/api/marketing/campaigns/${wizardState.editingId}` : '/api/marketing/campaigns';
            const method = isEdit ? 'PUT' : 'POST';

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            showToast(isEdit ? 'Campanha atualizada!' : 'Campanha criada!');
            closeModal();
            loadCampaigns();
        }

        async function startCampaign(id, status = '') {
            if (status === 'completed') {
                if (!confirm('Deseja realmente reenviar esta campanha? Todo o progresso de envio, abertura e cliques será zerado para os leads selecionados.')) return;
                return restartCampaign(id);
            }
            await fetch(`/api/marketing/campaigns/${id}/start`, { method: 'POST' });
            showToast('Campanha iniciada!', 'info');
            loadCampaigns();
        }

        async function restartCampaign(id) {
            showToast('Reiniciando campanha...', 'info');
            await fetch(`/api/marketing/campaigns/${id}/restart`, { method: 'POST' });
            showToast('Campanha reiniciada!');
            loadCampaigns();
        }

        async function stopCampaign(id) {
            await fetch(`/api/marketing/campaigns/${id}/stop`, { method: 'POST' });
            showToast('Campanha pausada', 'info');
            loadCampaigns();
        }

        async function deleteCampaign(id) {
            if (!confirm('Remover campanha?')) return;
            await fetch(`/api/marketing/campaigns/${id}`, { method: 'DELETE' });
            loadCampaigns();
        }

        // --- Lead Capture ---
        let allForms = [];
        async function loadForms() {
            try {
                const res = await fetch('/api/marketing/forms');
                allForms = await res.json();
                renderForms();
            } catch (err) { showToast('Erro ao carregar formulários', 'error'); }
        }

        function renderForms() {
            const list = document.getElementById('formsList');
            list.innerHTML = allForms.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(f => `
                <div class="glass p-6 rounded-3xl border border-white/5 hover:border-cyan-500/20 transition-all group">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-bold text-white">${f.name}</h4>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">${f.description || 'Sem descrição'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-full text-[10px] uppercase font-bold ${f.status === 'active' ? 'bg-cyan-500/20 text-cyan-400' : 'bg-slate-500/20 text-slate-400'}">${f.status === 'active' ? 'Ativo' : 'Inativo'}</span>
                            <button onclick="toggleFormStatus('${f.id}')" class="w-8 h-4 bg-slate-800 rounded-full relative transition-all ${f.status === 'active' ? 'bg-cyan-500/60' : ''}">
                                <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all ${f.status === 'active' ? 'translate-x-4' : ''}"></div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 mb-6 text-[10px] text-slate-500 font-bold uppercase tracking-tight">
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-white/5 rounded-lg border border-white/5">
                            <i class="fas fa-tag text-cyan-400"></i>
                            <span class="text-white">${f.autoTag}</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-white/5 rounded-lg border border-white/5">
                            <i class="fas fa-eye text-slate-400"></i>
                            <span class="text-white">${f.views || 0}</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-white/5 rounded-lg border border-white/5">
                            <i class="fas fa-user-plus text-cyan-400"></i>
                            <span class="text-white">${f.submissions || 0}</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-white/5 rounded-lg border border-white/5">
                            <i class="fas fa-user-minus text-rose-400"></i>
                            <span class="text-white">${(f.views || 0) - (f.submissions || 0)}</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-white/5 rounded-lg border border-white/5">
                            <i class="fas fa-user text-slate-600"></i>
                            <span class="text-white">${f.createdBy || 'Sistema'}</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-white/5">
                        <div class="flex items-center gap-1">
                            <button onclick="openFormDesign('${f.id}')" class="p-2.5 text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 rounded-xl transition-all" title="Personalizar Design">
                                <i class="fas fa-palette"></i>
                            </button>
                            <button onclick="copyFormLink('${f.id}')" class="p-2.5 text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 rounded-xl transition-all" title="Copiar Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <a href="/f/${f.id}" target="_blank" class="p-2.5 text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 rounded-xl transition-all" title="Visualizar">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                        <button onclick="deleteFormCapture('${f.id}')" class="p-2.5 text-slate-500 hover:text-rose-400 hover:bg-rose-500/10 rounded-xl transition-all">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('') || `
                <div class="col-span-full py-12 text-center">
                    <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10">
                        <i class="fas fa-filter text-2xl text-slate-600"></i>
                    </div>
                    <p class="text-slate-500">Nenhum formulário criado ainda.</p>
                </div>
            `;
        }

        async function toggleFormStatus(id) {
            const form = allForms.find(f => f.id === id);
            if (!form) return;
            form.status = form.status === 'active' ? 'inactive' : 'active';
            await fetch(`/api/marketing/forms/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(form)
            });
            renderForms();
        }

        async function deleteFormCapture(id) {
            if (!confirm('Deseja realmente excluir este formulário?')) return;
            await fetch(`/api/marketing/forms/${id}`, { method: 'DELETE' });
            loadForms();
        }

        function copyFormLink(id) {
            const url = `${window.location.origin}/f/${id}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link do formulário copiado!');
            });
        }

        // --- Settings ---
        async function loadConfig() {
            try {
                const config = await (await fetch('/api/marketing/config')).json();
                document.getElementById('set-email').value = config.senderEmail || '';
                document.getElementById('set-name').value = config.senderName || '';
                document.getElementById('set-baseUrl').value = config.baseUrl || window.location.origin;
                document.getElementById('set-host').value = config.smtpHost || '';
                document.getElementById('set-port').value = config.smtpPort || '';
                document.getElementById('set-pass').value = config.smtpPassword || '';
                document.getElementById('set-ignoreCert').checked = config.smtpIgnoreCertErrors || false;
                document.getElementById('set-forceSecure').value = config.smtpForceSecure || 'auto';
            } catch (err) { }
        }

        async function saveConfig() {
            const port = parseInt(document.getElementById('set-port').value);
            const data = {
                senderEmail: document.getElementById('set-email').value,
                senderName: document.getElementById('set-name').value,
                baseUrl: document.getElementById('set-baseUrl').value,
                smtpHost: document.getElementById('set-host').value,
                smtpPort: port,
                smtpPassword: document.getElementById('set-pass').value,
                smtpIgnoreCertErrors: document.getElementById('set-ignoreCert').checked,
                smtpForceSecure: document.getElementById('set-forceSecure').value
            };
            await fetch('/api/marketing/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast('Configurações salvas!');
        }

        // --- Stats ---
        let perfChart = null;

        async function loadStats() {
            try {
                const leads = await (await fetch('/api/marketing/leads')).json();
                const images = await (await fetch('/api/images')).json();
                const campaigns = await (await fetch('/api/marketing/campaigns')).json();
                const forms = await (await fetch('/api/marketing/forms')).json();

                document.getElementById('stat-leads').innerText = leads.length;
                document.getElementById('stat-images').innerText = images.length;
                document.getElementById('stat-active-camp').innerText = campaigns.filter(c => c.status === 'running').length;

                let totalSent = 0;
                campaigns.forEach(c => totalSent += (c.sentCount || 0));
                document.getElementById('stat-sent').innerText = totalSent;

                let totalCaptures = 0;
                forms.forEach(f => totalCaptures += (f.submissions || 0));
                document.getElementById('stat-captures').innerText = totalCaptures;

                // Render Chart
                renderPerformanceChart(campaigns);
            } catch (err) { }
        }

        async function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            try {
                const res = await fetch('/api/marketing/stats/performance');
                const stats = await res.json();
                const labels = stats.map(s => s.date);
                const successData = stats.map(s => s.success);
                const failedData = stats.map(s => s.failed);
                if (perfChart) perfChart.destroy();
                perfChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Sucesso',
                                data: successData,
                                borderColor: '#22d3ee',
                                backgroundColor: 'rgba(34, 211, 238, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Falhas',
                                data: failedData,
                                borderColor: '#f43f5e',
                                backgroundColor: 'rgba(244, 63, 94, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            } catch (err) { }
        }

        // --- Utils ---
        async function fetchTags() {
            try {
                const res = await fetch('/api/marketing/tags');
                return await res.json();
            } catch (err) { return []; }
        }

        async function initTagPicker(containerId, initialTags = [], onChange = null) {
            const container = document.getElementById(containerId);
            const allTags = await fetchTags();
            let selectedTags = [...initialTags];

            function render() {
                container.innerHTML = `
                    <div class="flex flex-wrap gap-2 p-3 bg-slate-900/50 border border-white/10 rounded-xl min-h-[50px]">
                        ${selectedTags.map(t => `
                            <span class="flex items-center gap-1.5 px-2 py-1 bg-cyan-500/10 text-cyan-400 rounded-lg text-xs font-bold border border-cyan-500/20">
                                ${t}
                                <button onclick="removeTagFromPicker('${containerId}', '${t}')" class="hover:text-rose-400 transition-colors"><i class="fas fa-times"></i></button>
                            </span>
                        `).join('')}
                        <input type="text" placeholder="Adicionar tag..." 
                            class="flex-1 min-w-[100px] bg-transparent outline-none text-xs text-white"
                            onfocus="showTagDropdown('${containerId}')"
                            oninput="filterTagDropdown('${containerId}', this.value)"
                            onkeydown="handleTagKeyDown(event, '${containerId}')">
                    </div>
                    <div id="${containerId}-dropdown" class="absolute left-0 right-0 mt-2 bg-slate-900 border border-white/10 rounded-xl shadow-2xl z-[70] hidden max-h-48 overflow-y-auto p-2 space-y-1">
                        ${allTags.filter(t => !selectedTags.includes(t)).map(t => `
                            <button onclick="addTagToPicker('${containerId}', '${t}')" class="w-full text-left px-3 py-2 text-xs text-slate-400 hover:bg-white/5 hover:text-white rounded-lg transition-all flex items-center justify-between">
                                ${t}
                                <i class="fas fa-plus opacity-0 group-hover:opacity-100"></i>
                            </button>
                        `).join('')}
                    </div>
                `;
                container.dataset.tags = JSON.stringify(selectedTags);
                if (onChange) onChange(selectedTags);
            }

            window.addTagToPicker = (cid, tag) => {
                const dat = JSON.parse(document.getElementById(cid).dataset.tags);
                if (!dat.includes(tag)) dat.push(tag);
                document.getElementById(cid).dataset.tags = JSON.stringify(dat);
                selectedTags = dat;
                render();
            };

            window.removeTagFromPicker = (cid, tag) => {
                const dat = JSON.parse(document.getElementById(cid).dataset.tags);
                const index = dat.indexOf(tag);
                if (index > -1) dat.splice(index, 1);
                document.getElementById(cid).dataset.tags = JSON.stringify(dat);
                selectedTags = dat;
                render();
            };

            window.showTagDropdown = (cid) => {
                document.getElementById(`${cid}-dropdown`).classList.remove('hidden');
            };

            window.filterTagDropdown = (cid, val) => {
                const drop = document.getElementById(`${cid}-dropdown`);
                const buttons = drop.querySelectorAll('button');
                buttons.forEach(b => {
                    const txt = b.innerText.toLowerCase();
                    b.style.display = txt.includes(val.toLowerCase()) ? 'flex' : 'none';
                });
            };

            window.handleTagKeyDown = (e, cid) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const val = e.target.value.trim();
                    if (val) addTagToPicker(cid, val);
                    e.target.value = '';
                }
            };

            // Global click to close dropdowns
            window.addEventListener('click', (e) => {
                if (!e.target.closest(`#${containerId}`)) {
                    const drop = document.getElementById(`${cid}-dropdown`);
                    if (drop) drop.classList.add('hidden');
                }
            });

            render();
        }
        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById('modalOverlay').classList.remove('flex');
        }

        function openProfileModal() {
            resetModal();
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            modal.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-white">Meu Perfil</h3>
                        <p class="text-sm text-slate-500">Atualize suas informações de conta.</p>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-6 p-6 bg-white/5 rounded-3xl border border-white/10">
                            <div class="relative group/avatar">
                                <div class="w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center text-cyan-400 border-2 border-white/10 overflow-hidden shrink-0 shadow-2xl">
                                    <img id="prof-preview" src="${currentUser.avatar || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover ${!currentUser.avatar ? 'opacity-20' : ''}">
                                    ${!currentUser.avatar ? '<i class="fas fa-user text-3xl absolute"></i>' : ''}
                                </div>
                                <button onclick="triggerAvatarUpload()" 
                                    class="absolute inset-0 bg-black/60 opacity-0 group-hover/avatar:opacity-100 flex items-center justify-center rounded-full transition-all text-white text-xs font-bold">
                                    <i class="fas fa-camera mr-2"></i> Alterar
                                </button>
                                <input type="file" id="prof-upload-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
                            </div>
                            <div class="flex-1">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Avatar do Usuário</label>
                                <div class="flex gap-2">
                                    <input type="text" id="prof-avatar" value="${currentUser.avatar || ''}" 
                                        placeholder="URL da imagem ou faça upload..."
                                        class="flex-1 bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-cyan-500 transition-all font-mono">
                                    <button onclick="triggerAvatarUpload()" class="px-4 bg-white/5 hover:bg-white/10 text-cyan-400 rounded-xl border border-cyan-500/20 transition-all" title="Fazer Upload">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                </div>
                                <p class="text-[9px] text-slate-500 mt-2 italic">A imagem será salva automaticamente no HDT Gallery.</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Nome Completo</label>
                            <input type="text" id="prof-name" value="${currentUser.name}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Nova Senha</label>
                            <input type="password" id="prof-pass" placeholder="Deixe em branco para manter" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500 transition-all">
                        </div>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="closeModal()" class="flex-1 py-4 bg-white/5 text-white rounded-2xl font-bold hover:bg-white/10 transition-all">Cancelar</button>
                        <button onclick="updateProfile()" class="flex-1 py-4 bg-cyan-600 text-white rounded-2xl font-bold hover:bg-cyan-700 transition-all shadow-xl shadow-cyan-600/30">Salvar Alterações</button>
                    </div>
                </div>
            `;
        }

        async function updateProfile() {
            const name = document.getElementById('prof-name').value;
            const avatar = document.getElementById('prof-avatar').value;
            const password = document.getElementById('prof-pass').value;

            const data = { name, avatar };
            if (password) data.password = password;

            try {
                showToast('Atualizando...', 'info');
                const res = await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const updated = await res.json();
                currentUser = updated;
                localStorage.setItem('hdt_user', JSON.stringify(currentUser));
                checkAuth();
                showToast('Perfil atualizado!');
                closeModal();
                loadImages(); // Update gallery
            } catch (err) { showToast('Erro ao atualizar', 'error'); }
        }

        function triggerAvatarUpload() {
            document.getElementById('prof-upload-input').click();
        }

        async function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);
            showToast('Enviando para HDT Gallery...', 'info');

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showToast('Upload concluído!');
                    const url = result.url;
                    document.getElementById('prof-avatar').value = url;
                    document.getElementById('prof-preview').src = url;
                    document.getElementById('prof-preview').classList.remove('opacity-20');
                    // Remove potential placeholder icon
                    const icon = document.querySelector('.relative.group\\/avatar i.fa-user');
                    if (icon) icon.remove();
                }
            } catch (err) { showToast('Erro no upload', 'error'); }
        }

        function toggleUserDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('hidden');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Link copiado para o email!');
            });
        }

        // Init
        // Refresh stats periodically
        setInterval(loadStats, 10000);
        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            if (currentUser) {
                loadStats();
                loadCampaigns();
            }

            // Close dropdowns on click outside
            window.addEventListener('click', (e) => {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    if (!e.target.closest('#userDropdown') && !e.target.closest('button[onclick*="toggleUserDropdown"]')) {
                        dropdown.classList.add('hidden');
                    }
                }
            });
        });

        // Drag & Drop for Gallery
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('image', file);
            showToast('Enviando...', 'info');
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showToast('Sucesso!');
                    loadImages();
                }
            } catch (err) { showToast('Erro no upload', 'error'); }
            fileInput.value = '';
        });

        // --- Lead Capture Wizard & Editor ---
        let formWizardState = { step: 1, data: {}, editingId: null };

        function openFormWizard(formId = null) {
            resetModal();
            if (formId) {
                const form = allForms.find(f => f.id === formId);
                formWizardState = { step: 1, data: JSON.parse(JSON.stringify(form)), editingId: formId };
            } else {
                formWizardState = {
                    step: 1,
                    editingId: null,
                    data: {
                        name: '', autoTag: '', description: '', eventTitle: '', eventDate: '',
                        accentColor: '#2563eb', additionalDetails: '',
                        fields: { name: true, email: true, phone: true, company: true, source: false },
                        styles: {
                            backgroundColor: '#0a0f1e', backgroundImage: '', font: 'Outfit', headerAlignment: 'center',
                            logo: '', banner: '', headerBgColor: 'transparent',
                            titleText: '', titleColor: '#ffffff', titleSize: '36px', titleWeight: 'bold',
                            subtitleText: '', subtitleColor: 'rgba(255,255,255,0.6)', subtitleSize: '14px',
                            cardBgColor: '#1a1f2e', cardBorderColor: 'rgba(255,255,255,0.1)', cardRadius: '12px', cardPadding: '32px',
                            labelColor: '#e2e8f0', inputBgColor: '#0f1420', inputBorderColor: 'rgba(255,255,255,0.15)',
                            inputTextColor: '#ffffff', inputRadius: '8px',
                            btnText: 'Confirmar Inscrição', btnBgColor: '#2563eb', btnTextColor: '#ffffff', btnRadius: '8px', btnFontSize: '16px',
                            footerText: 'Powered by HDT Conecte', footerTextColor: 'rgba(255,255,255,0.3)'
                        }
                    }
                };
            }
            renderFormWizard();
        }

        function renderFormWizard() {
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            modal.classList.add('max-w-2xl', 'p-8', 'rounded-3xl', 'max-h-[90vh]', 'overflow-y-auto');
            modal.classList.remove('modal-full');

            let content = '';
            if (formWizardState.step === 1) {
                content = `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-white">Novo Formulário de Captura</h3>
                            <button onclick="closeModal()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nome do Formulário *</label>
                                <input type="text" id="fw-name" value="${formWizardState.data.name || ''}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500" placeholder="Ex: Lead Gen Campanha A">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tag dos Leads *</label>
                                <input type="text" id="fw-tag" value="${formWizardState.data.autoTag || ''}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500" placeholder="Ex: inbound-site">
                                <p class="text-[10px] text-slate-500 mt-1">Os leads capturados receberão esta tag automaticamente</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Descrição</label>
                                <textarea id="fw-desc" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500 h-24" placeholder="Breve descrição do propósito do formulário">${formWizardState.data.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/5 flex justify-end">
                            <button onclick="nextFormStep()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all">Próximo</button>
                        </div>
                    </div>
                `;
            } else if (formWizardState.step === 2) {
                content = `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-white">Detalhes do Evento</h3>
                            <button onclick="closeModal()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Título do Evento</label>
                                <input type="text" id="fw-ev-title" value="${formWizardState.data.eventTitle || ''}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Data do Evento</label>
                                    <input type="text" id="fw-ev-date" value="${formWizardState.data.eventDate || ''}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500" placeholder="Ex: 12 de Fevereiro, 19h">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Cor de Destaque</label>
                                    <div class="flex items-center gap-2">
                                        <input type="color" id="fw-accent" value="${formWizardState.data.accentColor || '#2563eb'}" class="w-12 h-12 rounded-xl bg-slate-900 border-0 p-1 cursor-pointer">
                                        <input type="text" value="${formWizardState.data.accentColor || '#2563eb'}" oninput="document.getElementById('fw-accent').value = this.value" class="flex-1 bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Detalhes Adicionais</label>
                                <textarea id="fw-extra" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500 h-24">${formWizardState.data.additionalDetails || ''}</textarea>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/5 flex justify-between">
                            <button onclick="formWizardState.step--; renderFormWizard();" class="px-8 py-3 bg-white/5 text-white rounded-xl font-bold hover:bg-white/10 transition-all">Voltar</button>
                            <button onclick="nextFormStep()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all">Próximo</button>
                        </div>
                    </div>
                `;
            } else if (formWizardState.step === 3) {
                const fields = formWizardState.data.fields;
                content = `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-white">Campos do Formulário</h3>
                            <button onclick="closeModal()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-3">
                            ${[
                        { id: 'name', label: 'Nome Completo' },
                        { id: 'email', label: 'E-mail', required: true },
                        { id: 'phone', label: 'Celular / WhatsApp' },
                        { id: 'company', label: 'Empresa' },
                        { id: 'source', label: 'Como nos conheceu?' }
                    ].map(f => `
                                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <div>
                                        <p class="text-sm font-bold text-white">${f.label} ${f.required ? '<span class="text-rose-400">*</span>' : ''}</p>
                                    </div>
                                    <button onclick="toggleFwField('${f.id}')" class="w-10 h-5 bg-slate-800 rounded-full relative transition-all ${fields[f.id] ? 'bg-cyan-500/60' : ''} ${f.required ? 'opacity-50 cursor-not-allowed' : ''}">
                                        <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-all ${fields[f.id] ? 'translate-x-5' : ''}"></div>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="pt-4 border-t border-white/5 flex justify-between">
                            <button onclick="formWizardState.step--; renderFormWizard();" class="px-8 py-3 bg-white/5 text-white rounded-xl font-bold hover:bg-white/10 transition-all">Voltar</button>
                            <button onclick="saveFormCapture()" class="px-8 py-3 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all shadow-lg shadow-cyan-600/20">${formWizardState.editingId ? 'Salvar Alterações' : 'Criar Formulário'}</button>
                        </div>
                    </div>
                `;
            }
            modal.innerHTML = content;
        }

        function toggleFwField(field) {
            if (field === 'email') return;
            formWizardState.data.fields[field] = !formWizardState.data.fields[field];
            renderFormWizard();
        }

        function nextFormStep() {
            if (formWizardState.step === 1) {
                formWizardState.data.name = document.getElementById('fw-name').value;
                formWizardState.data.autoTag = document.getElementById('fw-tag').value;
                formWizardState.data.description = document.getElementById('fw-desc').value;
                if (!formWizardState.data.name || !formWizardState.data.autoTag) return showToast('Nome e Tag são obrigatórios', 'error');
            } else if (formWizardState.step === 2) {
                formWizardState.data.eventTitle = document.getElementById('fw-ev-title').value;
                formWizardState.data.eventDate = document.getElementById('fw-ev-date').value;
                formWizardState.data.accentColor = document.getElementById('fw-accent').value;
                formWizardState.data.additionalDetails = document.getElementById('fw-extra').value;
                // Sync some styles with accent color
                formWizardState.data.styles.btnBgColor = formWizardState.data.accentColor;
            }
            formWizardState.step++;
            renderFormWizard();
        }

        async function saveFormCapture() {
            const method = formWizardState.editingId ? 'PUT' : 'POST';
            const url = formWizardState.editingId ? `/api/marketing/forms/${formWizardState.editingId}` : '/api/marketing/forms';

            if (!formWizardState.editingId) {
                formWizardState.data.status = 'active';
                formWizardState.data.createdAt = new Date();
                formWizardState.data.submissions = 0;
                formWizardState.data.views = 0;
                formWizardState.data.createdBy = currentUser ? currentUser.name : 'Sistema';
            }

            try {
                showToast('Salvando formulário...', 'info');
                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formWizardState.data)
                });
                showToast('Formulário salvo com sucesso!');
                closeModal();
                loadForms();
            } catch (err) { showToast('Erro ao salvar formulário', 'error'); }
        }

        // --- Visual Editor for Forms ---
        let editingForm = null;

        function openFormDesign(id) {
            editingForm = allForms.find(f => f.id === id);
            if (!editingForm) return;

            resetModal();
            const modal = document.getElementById('modalContent');
            const overlay = document.getElementById('modalOverlay');

            modal.classList.add('modal-full');
            modal.classList.remove('p-8', 'max-w-4xl', 'max-h-[90vh]', 'rounded-3xl', 'overflow-y-auto');
            overlay.classList.add('p-0');
            overlay.classList.add('flex');
            overlay.classList.remove('hidden');

            modal.innerHTML = `
                <div class="flex flex-col h-screen text-slate-300 font-['Inter']">
                    <!-- Top Bar -->
                    <div class="h-16 border-b border-white/10 bg-slate-900 flex items-center justify-between px-6 shrink-0 z-50">
                        <div class="flex items-center gap-4">
                            <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-white/5 flex items-center justify-center transition-all">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h3 class="text-sm font-bold text-white">Editor Visual — ${editingForm.name}</h3>
                                <p class="text-[10px] text-slate-500">Personalize a aparência do formulário público</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                             <a href="/f/${editingForm.id}" target="_blank" class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold text-slate-300 hover:bg-white/10 transition-all flex items-center gap-2">
                                <i class="fas fa-eye"></i> Visualizar
                            </a>
                            <button onclick="saveFormStyles()" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">
                                Salvar
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-1 overflow-hidden bg-slate-950">
                        <!-- Sidebar (Controls) -->
                        <div class="w-80 border-r border-white/10 bg-slate-900/50 flex flex-col overflow-y-auto">
                            <div class="p-5 space-y-6">
                                <!-- Section: Página -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                                        <i class="fas fa-desktop text-cyan-400"></i> Página
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Cor de Fundo</label>
                                            <div class="flex items-center gap-2">
                                                <input type="color" value="${editingForm.styles.backgroundColor}" oninput="updateFormLive('backgroundColor', this.value)" class="w-8 h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                                <input type="text" value="${editingForm.styles.backgroundColor}" oninput="updateFormLive('backgroundColor', this.value)" class="flex-1 bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Imagem de Fundo</label>
                                            <button onclick="pickFormImage('backgroundImage')" class="w-full py-2 bg-white/5 border border-white/10 border-dashed rounded-lg text-[10px] font-bold hover:bg-white/10 transition-all">
                                                <i class="fas fa-upload mr-1 text-cyan-400"></i> Enviar imagem ou GIF
                                            </button>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Fonte</label>
                                            <select onchange="updateFormLive('font', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                                <option value="Outfit" ${editingForm.styles.font === 'Outfit' ? 'selected' : ''}>Outfit</option>
                                                <option value="Inter" ${editingForm.styles.font === 'Inter' ? 'selected' : ''}>Inter</option>
                                                <option value="Roboto" ${editingForm.styles.font === 'Roboto' ? 'selected' : ''}>Roboto</option>
                                                <option value="Arial" ${editingForm.styles.font === 'Arial' ? 'selected' : ''}>Arial</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section: Cabeçalho -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest pt-2 border-t border-white/5">
                                        <i class="fas fa-heading text-cyan-400"></i> Cabeçalho
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Logo</label>
                                            <button onclick="pickFormImage('logo')" class="w-full py-2 bg-white/5 border border-white/10 border-dashed rounded-lg text-[10px] font-bold hover:bg-white/10 transition-all">
                                                <i class="fas fa-image mr-1 text-cyan-400"></i> Enviar imagem ou GIF
                                            </button>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Banner (imagem ou GIF)</label>
                                            <button onclick="pickFormImage('banner')" class="w-full py-2 bg-white/5 border border-white/10 border-dashed rounded-lg text-[10px] font-bold hover:bg-white/10 transition-all">
                                                <i class="fas fa-image mr-1 text-cyan-400"></i> Enviar imagem ou GIF
                                            </button>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Cor de Fundo do Cabeçalho</label>
                                            <input type="text" value="${editingForm.styles.headerBgColor}" oninput="updateFormLive('headerBgColor', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Alinhamento</label>
                                            <div class="flex gap-1 bg-slate-900 p-1 rounded-lg border border-white/5">
                                                <button onclick="updateFormLive('headerAlignment', 'left')" class="flex-1 py-1 px-2 rounded-md text-[9px] font-bold uppercase ${editingForm.styles.headerAlignment === 'left' ? 'bg-blue-600 text-white' : 'hover:bg-white/5 text-slate-400'}">Esq.</button>
                                                <button onclick="updateFormLive('headerAlignment', 'center')" class="flex-1 py-1 px-2 rounded-md text-[9px] font-bold uppercase ${editingForm.styles.headerAlignment === 'center' ? 'bg-blue-600 text-white' : 'hover:bg-white/5 text-slate-400'}">Centro</button>
                                                <button onclick="updateFormLive('headerAlignment', 'right')" class="flex-1 py-1 px-2 rounded-md text-[9px] font-bold uppercase ${editingForm.styles.headerAlignment === 'right' ? 'bg-blue-600 text-white' : 'hover:bg-white/5 text-slate-400'}">Dir.</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section: Título e Subtítulo -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest pt-2 border-t border-white/5">
                                        <i class="fas fa-font text-cyan-400"></i> Título e Subtítulo
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Texto do Título (vazio = usa o título do evento)</label>
                                            <input type="text" value="${editingForm.styles.titleText}" placeholder="${editingForm.eventTitle}" oninput="updateFormLive('titleText', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Cor do Título</label>
                                                <input type="color" value="${editingForm.styles.titleColor}" oninput="updateFormLive('titleColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Tamanho</label>
                                                <input type="text" value="${editingForm.styles.titleSize}" oninput="updateFormLive('titleSize', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Peso da Fonte</label>
                                            <select onchange="updateFormLive('titleWeight', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                                <option value="normal" ${editingForm.styles.titleWeight === 'normal' ? 'selected' : ''}>Normal</option>
                                                <option value="bold" ${editingForm.styles.titleWeight === 'bold' ? 'selected' : ''}>Bold</option>
                                                <option value="900" ${editingForm.styles.titleWeight === '900' ? 'selected' : ''}>Extra Bold</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Texto do Subtítulo (vazio = usa a data do evento)</label>
                                            <input type="text" value="${editingForm.styles.subtitleText}" placeholder="${editingForm.eventDate}" oninput="updateFormLive('subtitleText', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Cor</label>
                                                <input type="color" value="${editingForm.styles.subtitleColor.startsWith('#') ? editingForm.styles.subtitleColor : '#94a3b8'}" oninput="updateFormLive('subtitleColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Tamanho</label>
                                                <input type="text" value="${editingForm.styles.subtitleSize}" oninput="updateFormLive('subtitleSize', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section: Formulário -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest pt-2 border-t border-white/5">
                                        <i class="fas fa-list-alt text-cyan-400"></i> Formulário
                                    </div>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Fundo do Card</label>
                                                <input type="color" value="${editingForm.styles.cardBgColor}" oninput="updateFormLive('cardBgColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Cor da Borda</label>
                                                <input type="color" value="${editingForm.styles.cardBorderColor.startsWith('#') ? editingForm.styles.cardBorderColor : '#334155'}" oninput="updateFormLive('cardBorderColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Arredondamento</label>
                                                <input type="text" value="${editingForm.styles.cardRadius}" oninput="updateFormLive('cardRadius', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Espaçamento</label>
                                                <input type="text" value="${editingForm.styles.cardPadding}" oninput="updateFormLive('cardPadding', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                            </div>
                                        </div>
                                        <div class="pt-2">
                                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Estilo dos Inputs</p>
                                            <div class="space-y-2">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-[10px] text-slate-500 mb-1">Cor Rótulo</label>
                                                        <input type="color" value="${editingForm.styles.labelColor}" oninput="updateFormLive('labelColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                                    </div>
                                                    <div>
                                                        <label class="block text-[10px] text-slate-500 mb-1">Fundo Input</label>
                                                        <input type="color" value="${editingForm.styles.inputBgColor}" oninput="updateFormLive('inputBgColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section: Botão -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest pt-2 border-t border-white/5">
                                        <i class="fas fa-mouse-pointer text-cyan-400"></i> Botão
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Texto do Botão</label>
                                            <input type="text" value="${editingForm.styles.btnText}" oninput="updateFormLive('btnText', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Fundo</label>
                                                <input type="color" value="${editingForm.styles.btnBgColor}" oninput="updateFormLive('btnBgColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-500 mb-1">Cor Texto</label>
                                                <input type="color" value="${editingForm.styles.btnTextColor}" oninput="updateFormLive('btnTextColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section: Rodapé -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest pt-2 border-t border-white/5">
                                        <i class="fas fa-info-circle text-cyan-400"></i> Rodapé
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Texto do Rodapé</label>
                                            <input type="text" value="${editingForm.styles.footerText}" oninput="updateFormLive('footerText', this.value)" class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Cor do Texto</label>
                                            <input type="color" value="${editingForm.styles.footerTextColor.startsWith('#') ? editingForm.styles.footerTextColor : '#64748b'}" oninput="updateFormLive('footerTextColor', this.value)" class="w-full h-8 rounded-lg bg-slate-800 border-0 p-0 cursor-pointer">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Workspace (Preview) -->
                        <div class="flex-1 bg-slate-950/20 relative overflow-y-auto p-12">
                            <div id="form-preview-container" class="max-w-4xl mx-auto min-h-full">
                                <!-- The form will be rendered here via JS -->
                                <div id="live-form-root"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateFormPreview();
        }

        function updateFormLive(prop, val) {
            editingForm.styles[prop] = val;
            updateFormPreview();
        }

        function updateFormPreview() {
            const root = document.getElementById('live-form-root');
            if (!root) return;

            const s = editingForm.styles;
            const f = editingForm.fields;

            // Build the form HTML
            root.innerHTML = `
                <div style="background-color: ${s.backgroundColor}; background-image: ${s.backgroundImage ? `url(${s.backgroundImage})` : 'none'}; background-size: cover; background-position: center; font-family: ${s.font}; min-height: 80vh; padding: 40px 20px; border-radius: 20px; color: #fff;">
                    <header style="text-align: ${s.headerAlignment}; background-color: ${s.headerBgColor}; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        ${s.logo ? `<img src="${s.logo}" style="max-height: 60px; margin-bottom: 20px; display: inline-block;">` : ''}
                        ${s.banner ? `<img src="${s.banner}" style="width: 100%; max-width: 600px; border-radius: 12px; margin-bottom: 20px; display: inline-block;">` : ''}
                        <h1 style="color: ${s.titleColor}; font-size: ${s.titleSize}; font-weight: ${s.titleWeight}; margin-bottom: 10px;">${s.titleText || editingForm.eventTitle || 'Título do Evento'}</h1>
                        <p style="color: ${s.subtitleColor}; font-size: ${s.subtitleSize};">${s.subtitleText || editingForm.eventDate || 'Data do Evento'}</p>
                    </header>

                    <div style="max-width: 500px; margin: 0 auto; background: ${s.cardBgColor}; border: 1px solid ${s.cardBorderColor}; border-radius: ${s.cardRadius}; padding: ${s.cardPadding}; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: ${s.titleColor};">Inscreva-se</h2>
                        ${editingForm.description ? `<p style="font-size: 13px; color: ${s.subtitleColor}; margin-bottom: 25px;">${editingForm.description}</p>` : ''}
                        
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${f.name ? `
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px;">Nome Completo</label>
                                <input type="text" placeholder="Seu nome completo" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 10px 15px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                            </div>` : ''}
                            
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px;">E-mail *</label>
                                <input type="email" placeholder="seu@email.com" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 10px 15px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                            </div>

                            ${f.phone ? `
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px;">Celular / WhatsApp</label>
                                <input type="text" placeholder="(11) 99999-9999" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 10px 15px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                            </div>` : ''}

                            ${f.company ? `
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px;">Empresa</label>
                                <input type="text" placeholder="Nome da empresa" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 10px 15px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                            </div>` : ''}
                            
                            ${f.source ? `
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px;">Como nos conheceu?</label>
                                <select style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 10px 15px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                                    <option>Instagram / Facebook</option>
                                    <option>Indicação</option>
                                    <option>Google / YouTube</option>
                                    <option>Outros</option>
                                </select>
                            </div>` : ''}

                            <button style="width: 100%; background: ${s.btnBgColor}; color: ${s.btnTextColor}; border-radius: ${s.btnRadius}; padding: 15px; font-weight: bold; font-size: ${s.btnFontSize}; margin-top: 10px; border: none; cursor: pointer; transition: opacity 0.2s;">
                                ${s.btnText}
                            </button>
                        </div>
                    </div>

                    <footer style="text-align: center; margin-top: 40px; color: ${s.footerTextColor}; font-size: 11px; font-weight: bold; text-transform: uppercase;">
                        ${s.footerText}
                    </footer>
                    ${editingForm.additionalDetails ? `<p style="text-align: center; color: ${s.footerTextColor}; font-size: 10px; margin-top: 10px;">${editingForm.additionalDetails}</p>` : ''}
                </div>
            `;
        }

        async function saveFormStyles() {
            try {
                showToast('Salvando visual...', 'info');
                await fetch(`/api/marketing/forms/${editingForm.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editingForm)
                });
                showToast('Design salvo com sucesso!');
                loadForms();
            } catch (err) { showToast('Erro ao salvar visual', 'error'); }
        }

        function pickFormImage(prop) {
            const url = prompt('Cole a URL da imagem ou GIF:');
            if (url) updateFormLive(prop, url);
        }

        window.closeModal = closeModal;

        // --- Public Form Rendering ---
        async function renderPublicForm(formId) {
            try {
                // Log View
                fetch(`/api/marketing/forms/${formId}/view`, { method: 'POST' });

                const res = await fetch('/api/marketing/forms');
                const forms = await res.json();
                const form = forms.find(f => f.id === formId);

                if (!form || form.status !== 'active') {
                    document.body.innerHTML = `
                        <div class="flex items-center justify-center min-h-screen bg-slate-950 text-white">
                            <div class="text-center p-8 bg-white/5 rounded-3xl border border-white/10">
                                <h2 class="text-2xl font-bold mb-2">Formulário Indisponível</h2>
                                <p class="text-slate-400">Este link expirou ou o formulário foi desativado.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const s = form.styles;
                const f = form.fields;

                // Create a clean public view
                document.body.className = "bg-slate-950";
                document.body.innerHTML = `
                    <div id="public-form-root" style="background-color: ${s.backgroundColor}; background-image: ${s.backgroundImage ? `url(${s.backgroundImage})` : 'none'}; background-size: cover; background-position: center; font-family: ${s.font}; min-height: 100vh; padding: 60px 20px; color: #fff;">
                        <div class="max-w-4xl mx-auto">
                            <header style="text-align: ${s.headerAlignment}; background-color: ${s.headerBgColor}; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                                ${s.logo ? `<img src="${s.logo}" style="max-height: 80px; margin-bottom: 24px; display: inline-block;">` : ''}
                                ${s.banner ? `<img src="${s.banner}" style="width: 100%; max-width: 800px; border-radius: 20px; margin-bottom: 24px; display: inline-block;">` : ''}
                                <h1 style="color: ${s.titleColor}; font-size: ${s.titleSize}; font-weight: ${s.titleWeight}; margin-bottom: 15px; line-height: 1.2;">${s.titleText || form.eventTitle || 'Título do Evento'}</h1>
                                <p style="color: ${s.subtitleColor}; font-size: ${s.subtitleSize}; font-weight: 500;">${s.subtitleText || form.eventDate || 'Data do Evento'}</p>
                            </header>

                            <div style="max-width: 500px; margin: 0 auto; background: ${s.cardBgColor}; border: 1px solid ${s.cardBorderColor}; border-radius: ${s.cardRadius}; padding: ${s.cardPadding}; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                                <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: ${s.titleColor};">Participe Agora</h2>
                                ${form.description ? `<p style="font-size: 14px; color: ${s.subtitleColor}; margin-bottom: 30px; line-height: 1.6;">${form.description}</p>` : ''}
                                
                                <form onsubmit="handlePublicSubmit(event, '${form.id}')" class="space-y-4">
                                    ${f.name ? `
                                    <div>
                                        <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em;">Nome Completo</label>
                                        <input type="text" id="p-name" placeholder="Seu nome completo" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 15px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='${form.accentColor}'" onblur="this.style.borderColor='${s.inputBorderColor}'">
                                    </div>` : ''}
                                    
                                    <div>
                                        <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em;">E-mail *</label>
                                        <input type="email" id="p-email" required placeholder="seu@email.com" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 15px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='${form.accentColor}'" onblur="this.style.borderColor='${s.inputBorderColor}'">
                                    </div>

                                    ${f.phone ? `
                                    <div>
                                        <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em;">Celular / WhatsApp</label>
                                        <input type="text" id="p-phone" placeholder="(11) 99999-9999" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 15px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='${form.accentColor}'" onblur="this.style.borderColor='${s.inputBorderColor}'">
                                    </div>` : ''}

                                    ${f.company ? `
                                    <div>
                                        <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em;">Empresa</label>
                                        <input type="text" id="p-company" placeholder="Nome da sua empresa" style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 15px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='${form.accentColor}'" onblur="this.style.borderColor='${s.inputBorderColor}'">
                                    </div>` : ''}
                                    
                                    ${f.source ? `
                                    <div>
                                        <label style="display: block; font-size: 11px; font-weight: bold; color: ${s.labelColor}; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em;">Como nos conheceu?</label>
                                        <select id="p-source" 
                                            onchange="document.getElementById('p-source-other').classList.toggle('hidden', this.value !== 'Outros')"
                                            style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 15px; outline: none; appearance: none; transition: border-color 0.2s;" 
                                            onfocus="this.style.borderColor='${form.accentColor}'" onblur="this.style.borderColor='${s.inputBorderColor}'">
                                            <option value="">Selecione uma opção...</option>
                                            <option>Google</option>
                                            <option>Facebook</option>
                                            <option>Instagram</option>
                                            <option>LinkedIn</option>
                                            <option>YouTube</option>
                                            <option>TikTok</option>
                                            <option>Indicação de amigo/colega</option>
                                            <option>Evento / Feira</option>
                                            <option>E-mail Marketing</option>
                                            <option>Site da Empresa</option>
                                            <option>WhatsApp</option>
                                            <option value="Outros">Outros</option>
                                        </select>
                                        <input type="text" id="p-source-other" placeholder="Por favor, especifique..." class="hidden mt-2" 
                                            style="width: 100%; background: ${s.inputBgColor}; border: 1px solid ${s.inputBorderColor}; border-radius: ${s.inputRadius}; padding: 12px 18px; color: ${s.inputTextColor}; font-size: 14px; outline: none;">
                                    </div>` : ''}

                                    <button type="submit" id="p-submit-btn" style="width: 100%; background: ${s.btnBgColor}; color: ${s.btnTextColor}; border-radius: ${s.btnRadius}; padding: 18px; font-weight: bold; font-size: ${s.btnFontSize}; margin-top: 15px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px ${s.btnBgColor}40;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px ${s.btnBgColor}60'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px ${s.btnBgColor}40'">
                                        ${s.btnText}
                                    </button>
                                </form>
                            </div>

                            <footer style="text-align: center; margin-top: 60px; color: ${s.footerTextColor}; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em;">
                                ${s.footerText}
                            </footer>
                            ${form.additionalDetails ? `<p style="text-align: center; color: ${s.footerTextColor}; font-size: 11px; margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.5;">${form.additionalDetails}</p>` : ''}
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                document.body.innerHTML = '<div class="text-white p-10">Erro ao carregar formulário.</div>';
            }
        }

        async function handlePublicSubmit(event, formId) {
            event.preventDefault();
            const btn = document.getElementById('p-submit-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Enviando...';

            const leadData = {
                email: document.getElementById('p-email').value,
                status: 'active'
            };

            const nameEl = document.getElementById('p-name');
            if (nameEl) leadData.name = nameEl.value;

            const phoneEl = document.getElementById('p-phone');
            if (phoneEl) leadData.phone = phoneEl.value;

            const companyEl = document.getElementById('p-company');
            if (companyEl) leadData.company = companyEl.value;

            const sourceEl = document.getElementById('p-source');
            if (sourceEl) {
                leadData.source = sourceEl.value === 'Outros' ? document.getElementById('p-source-other').value : sourceEl.value;
            }

            try {
                const res = await fetch(`/api/forms/${formId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leadData)
                });
                const result = await res.json();

                if (result.success) {
                    document.getElementById('public-form-root').innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[60vh] text-center p-8">
                            <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mb-6 border border-green-500/50">
                                <i class="fas fa-check text-3xl text-green-400"></i>
                            </div>
                            <h2 class="text-3xl font-bold mb-4">Inscrição Confirmada!</h2>
                            <p class="text-slate-400 text-lg max-w-md">Obrigado por se inscrever. Seus dados foram recebidos com sucesso.</p>
                            <button onclick="location.reload()" class="mt-8 px-8 py-3 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all text-sm font-bold uppercase tracking-widest">Fazer nova inscrição</button>
                        </div>
                    `;
                } else {
                    alert('Erro ao enviar: ' + (result.error || 'Erro desconhecido'));
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (err) {
                alert('Erro de conexão');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // --- Campaign Logs ---
        async function openLogsModal(campaignId) {
            resetModal('max-w-5xl'); // Wide modal for logs
            const modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white">Logs da Campanha</h2>
                        <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold" id="log-campaign-name">Carregando...</p>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2 transition-all"><i class="fas fa-times text-xl"></i></button>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <button onclick="filterLogs('all')" id="btn-log-all" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-cyan-500 text-white shadow-lg shadow-cyan-500/20">Todos</button>
                        <button onclick="filterLogs('sent')" id="btn-log-sent" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-white/5 border border-white/10 text-slate-400 hover:text-white">Enviados</button>
                        <button onclick="filterLogs('failed')" id="btn-log-failed" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-white/5 border border-white/10 text-slate-400 hover:text-white">Falhas</button>
                        <button onclick="filterLogs('opened')" id="btn-log-opened" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-white/5 border border-white/10 text-slate-400 hover:text-white">Abertos</button>
                        <button onclick="filterLogs('clicked')" id="btn-log-clicked" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-white/5 border border-white/10 text-slate-400 hover:text-white">Cliques</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-500 uppercase font-bold">Mostrar</span>
                        <select id="logs-per-page" onchange="changeLogRowsPerPage(this.value)" class="bg-slate-900 border border-white/10 rounded-lg px-3 py-1 text-xs text-white outline-none focus:border-cyan-500 cursor-pointer">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                        </select>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden border border-white/5">
                    <table class="w-full text-left">
                        <thead class="bg-white/5 border-b border-white/10">
                            <tr>
                                <th class="px-6 py-4 font-bold text-slate-400 text-[10px] uppercase tracking-widest">Data/Hora</th>
                                <th class="px-6 py-4 font-bold text-slate-400 text-[10px] uppercase tracking-widest">Email</th>
                                <th class="px-6 py-4 font-bold text-slate-400 text-[10px] uppercase tracking-widest">Status</th>
                                <th class="px-6 py-4 font-bold text-slate-400 text-[10px] uppercase tracking-widest">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-white/5">
                            <tr><td colspan="4" class="p-12 text-center text-slate-500">Buscando logs...</td></tr>
                        </tbody>
                    </table>
                    <div class="bg-white/5 px-6 py-4 flex items-center justify-between border-t border-white/10" id="log-pagination">
                        <!-- Pagination here -->
                    </div>
                </div>
            `;

            try {
                // Fetch campaign details to show name
                const campaigns = await (await fetch('/api/marketing/campaigns')).json();
                const campaign = campaigns.find(c => c.id === campaignId);
                if (campaign) document.getElementById('log-campaign-name').innerText = campaign.name;

                const res = await fetch(`/api/marketing/campaigns/${campaignId}/logs`);
                currentLogs = await res.json();
                currentLogs.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));

                filteredLogs = [...currentLogs];
                logPagination.currentPage = 1;
                renderLogsTable();
            } catch (err) {
                showToast('Erro ao carregar logs', 'error');
            }
        }

        function filterLogs(status) {
            activeLogFilter = status;
            // Update UI buttons
            ['all', 'sent', 'failed', 'opened', 'clicked'].forEach(s => {
                const btn = document.getElementById(`btn-log-${s}`);
                if (!btn) return;
                if (s === status) {
                    btn.className = "px-4 py-2 rounded-xl text-xs font-bold transition-all bg-cyan-500 text-white shadow-lg shadow-cyan-500/20";
                } else {
                    btn.className = "px-4 py-2 rounded-xl text-xs font-bold transition-all bg-white/5 border border-white/10 text-slate-400 hover:text-white";
                }
            });

            if (status === 'all') {
                filteredLogs = [...currentLogs];
            } else if (status === 'opened') {
                filteredLogs = currentLogs.filter(l => l.openedAt);
            } else if (status === 'clicked') {
                filteredLogs = currentLogs.filter(l => l.lastClickedAt || (l.clicks && l.clicks.length > 0));
            } else {
                filteredLogs = currentLogs.filter(l => l.status === status);
            }

            logPagination.currentPage = 1;
            renderLogsTable();
        }

        function renderLogsTable() {
            const tableBody = document.getElementById('logsTableBody');
            const startIndex = (logPagination.currentPage - 1) * logPagination.rowsPerPage;
            const endIndex = startIndex + logPagination.rowsPerPage;
            const pagedLogs = filteredLogs.slice(startIndex, endIndex);

            if (pagedLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="p-12 text-center text-slate-500">Nenhum log encontrado para este filtro.</td></tr>';
                document.getElementById('log-pagination').innerHTML = '';
                return;
            }

            tableBody.innerHTML = pagedLogs.map(l => {
                let statusHtml = '';
                if (l.status === 'sent') {
                    statusHtml = `<span class="px-2 py-0.5 bg-green-500/20 text-green-400 rounded-lg text-[9px] uppercase font-bold border border-green-500/20">Enviado</span>`;
                } else {
                    statusHtml = `<span class="px-2 py-0.5 bg-rose-500/20 text-rose-400 rounded-lg text-[9px] uppercase font-bold border border-rose-500/20">Falhou</span>`;
                }

                if (l.openedAt) statusHtml += ` <span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded-lg text-[9px] uppercase font-bold ml-1 border border-cyan-500/20">Aberto</span>`;
                if (l.lastClickedAt || (l.clicks && l.clicks.length > 0)) statusHtml += ` <span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded-lg text-[9px] uppercase font-bold ml-1 border border-blue-500/20">Clicou</span>`;

                const dateStr = new Date(l.sentAt).toLocaleString();
                const details = l.errorMsg ? `<span class="text-rose-400/80">${l.errorMsg}</span>` : `<span class="text-slate-500">Sucesso no disparo</span>`;

                return `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 text-[10px] text-slate-500 font-medium">${dateStr}</td>
                        <td class="px-6 py-4 text-xs text-white font-bold">${l.email}</td>
                        <td class="px-6 py-4">${statusHtml}</td>
                        <td class="px-6 py-4 text-[10px] max-w-xs truncate text-slate-400" title="${l.errorMsg || 'Sucesso'}">${details}</td>
                    </tr>
                `;
            }).join('');

            renderLogPagination();
        }

        function renderLogPagination() {
            const totalPages = Math.ceil(filteredLogs.length / logPagination.rowsPerPage);
            const container = document.getElementById('log-pagination');

            const startRange = (logPagination.currentPage - 1) * logPagination.rowsPerPage + 1;
            const endRange = Math.min(logPagination.currentPage * logPagination.rowsPerPage, filteredLogs.length);

            container.innerHTML = `
                <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Mostrando ${startRange}-${endRange} de ${filteredLogs.length}</span>
                <div class="flex items-center gap-2">
                    <button onclick="changeLogPage(${logPagination.currentPage - 1})" ${logPagination.currentPage === 1 ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-slate-400 disabled:opacity-20 hover:text-white transition-all"><i class="fas fa-chevron-left text-xs"></i></button>
                    <span class="text-xs font-bold text-white bg-white/5 px-3 py-2 rounded-xl border border-white/10">${logPagination.currentPage} / ${totalPages}</span>
                    <button onclick="changeLogPage(${logPagination.currentPage + 1})" ${logPagination.currentPage === totalPages ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-slate-400 disabled:opacity-20 hover:text-white transition-all"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            `;
        }

        function changeLogPage(page) {
            logPagination.currentPage = page;
            renderLogsTable();
        }

        function changeLogRowsPerPage(val) {
            logPagination.rowsPerPage = parseInt(val);
            logPagination.currentPage = 1;
            renderLogsTable();
        }

        window.closeModal = closeModal;

    </script>
</body>

</html>