<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDT Conecte | Unified Marketing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1a233a, #0a0f1e);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-hover:hover {
            border-color: rgba(6, 182, 212, 0.4);
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-tab {
            background: rgba(6, 182, 212, 0.15);
            color: #22d3ee;
            border-left: 3px solid #22d3ee;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(34, 211, 238, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(34, 211, 238, 0.4);
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 glass border-r hidden lg:flex flex-col fixed h-full z-50">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                        <i class="fas fa-bolt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-white">HDT Conecte</h1>
                        <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">Marketing Ecosystem</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-1">
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all active-tab">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </button>
                <button onclick="switchTab('gallery')" id="tab-gallery"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-images w-5"></i> HDT Gallery
                </button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Mail
                    Marketing</div>
                <button onclick="switchTab('leads')" id="tab-leads"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-users w-5"></i> Leads
                </button>
                <button onclick="switchTab('templates')" id="tab-templates"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-envelope-open-text w-5"></i> Modelos
                </button>
                <button onclick="switchTab('campaigns')" id="tab-campaigns"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-bullhorn w-5"></i> Campanhas
                </button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">System</div>
                <button onclick="switchTab('settings')" id="tab-settings"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5">
                    <i class="fas fa-cog w-5"></i> Configurações
                </button>
            </nav>

            <div class="p-6">
                <div
                    class="p-4 rounded-2xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-500/20">
                    <p class="text-xs font-semibold text-white">Self-hosted Node.js</p>
                    <p class="text-[10px] text-slate-400 mt-1">v2.0 Beta - Optimized</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 p-4 lg:p-8">

            <!-- Dashboard Section -->
            <section id="section-dashboard" class="space-y-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                        <p class="text-slate-400">Bem-vindo ao centro de comando da HDT ENERGY.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center text-blue-400">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Total Leads</p>
                        <h3 id="stat-leads" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-cyan-500/20 rounded-2xl flex items-center justify-center text-cyan-400">
                                <i class="fas fa-paper-plane text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Emails Enviados</p>
                        <h3 id="stat-sent" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-purple-500/20 rounded-2xl flex items-center justify-center text-purple-400">
                                <i class="fas fa-file-image text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Imagens na Galeria</p>
                        <h3 id="stat-images" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-amber-500/20 rounded-2xl flex items-center justify-center text-amber-400">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                        </div>
                        <p class="text-slate-400 text-sm">Campanhas Ativas</p>
                        <h3 id="stat-active-camp" class="text-3xl font-bold text-white mt-1">0</h3>
                    </div>
                </div>
            </section>

            <!-- Gallery Section -->
            <section id="section-gallery" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">HDT Gallery</h2>
                        <p class="text-slate-400">Links diretos para e-mails HTML.</p>
                    </div>
                    <button onclick="loadImages()"
                        class="p-3 glass rounded-xl text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- Dropzone -->
                <div id="dropzone"
                    class="glass rounded-3xl border-dashed border-2 border-slate-700 p-12 text-center relative overflow-hidden group hover:border-cyan-500/50 transition-all duration-300">
                    <input type="file" id="fileInput" accept="image/*"
                        class="opacity-0 absolute inset-0 cursor-pointer z-10">
                    <div class="flex flex-col items-center gap-4">
                        <div
                            class="w-20 h-20 bg-cyan-500/20 rounded-full flex items-center justify-center text-cyan-400 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-xl font-semibold text-white">Arraste & Solte Imagens</p>
                            <p class="text-slate-400 mt-1">PNG, JPG, GIF ou WebP (Máx 10MB)</p>
                        </div>
                    </div>
                </div>

                <div id="imageGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Images will load here -->
                </div>
            </section>

            <!-- Leads Section -->
            <section id="section-leads" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Gestão de Leads</h2>
                        <p class="text-slate-400">Base de contatos unificada.</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="importInput" accept=".csv,.xlsx" class="hidden"
                            onchange="importLeads(this)">
                        <button onclick="document.getElementById('importInput').click()"
                            class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                            <i class="fas fa-file-import"></i> Importar CSV/XLSX
                        </button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5 border-b border-white/10">
                            <tr>
                                <th class="px-6 py-4 font-bold text-slate-300">Nome</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Email</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Telefone</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Empresa</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Cidade/UF</th>
                                <th class="px-6 py-4 font-bold text-slate-300">CPF/CNPJ</th>
                                <th class="px-6 py-4 font-bold text-slate-300">Tags</th>
                                <th class="px-6 py-4 font-bold text-slate-300 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTable" class="divide-y divide-white/5">
                            <!-- Leads here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="section-templates" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Modelos de Email</h2>
                        <p class="text-slate-400">Crie layouts HTML impactantes.</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="templateInput" accept=".html" class="hidden"
                            onchange="uploadTemplate(this)">
                        <button onclick="document.getElementById('templateInput').click()"
                            class="px-6 py-3 bg-white/5 border border-white/10 text-white rounded-xl font-bold hover:bg-white/10 transition-all flex items-center gap-2">
                            <i class="fas fa-upload"></i> Upload HTML
                        </button>
                        <button onclick="openTemplateEditor()"
                            class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all flex items-center gap-2">
                            <i class="fas fa-plus"></i> Novo Modelo
                        </button>
                    </div>
                </div>

                <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Templates here -->
                </div>
            </section>

            <!-- Campaigns Section -->
            <section id="section-campaigns" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Campanhas</h2>
                        <p class="text-slate-400">Envios em massa com controle de entrega.</p>
                    </div>
                    <button onclick="openCampaignWizard()"
                        class="px-6 py-3 bg-cyan-500 text-white rounded-xl font-bold hover:bg-cyan-600 transition-all flex items-center gap-2">
                        <i class="fas fa-rocket"></i> Lançar Campanha
                    </button>
                </div>

                <div id="campaignsList" class="space-y-4">
                    <!-- Campaigns here -->
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="hidden space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">Configurações</h2>
                    <p class="text-slate-400">Configure seu servidor de e-mail e informações do remetente.</p>
                </div>

                <div class="space-y-8 max-w-4xl">
                    <!-- Informações do Remetente -->
                    <div class="glass p-8 rounded-3xl space-y-6">
                        <h3 class="text-xl font-bold text-white">Informações do Remetente</h3>
                        <p class="text-sm text-slate-400 -mt-4">Como você aparecerá para os destinatários.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Nome do Remetente</label>
                                <input type="text" id="set-name" placeholder="HDT Energy | No-Reply"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Email do Remetente</label>
                                <input type="email" id="set-email" placeholder="hdt@hdt.energy"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Método de Envio -->
                    <div class="glass p-8 rounded-3xl space-y-6">
                        <h3 class="text-xl font-bold text-white">Método de Envio</h3>
                        <p class="text-sm text-slate-400 -mt-4">Escolha como os e-mails serão enviados.</p>

                        <div class="space-y-4">
                            <label
                                class="flex items-center gap-4 p-4 bg-slate-900/50 border border-white/10 rounded-2xl cursor-pointer hover:border-cyan-500/50 transition-all group has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/5">
                                <input type="radio" name="send-method" value="smtp" checked
                                    class="w-5 h-5 accent-cyan-500">
                                <div>
                                    <p class="font-bold text-white">SMTP Relay</p>
                                    <p class="text-xs text-slate-400">Protocolo padrão de email. Funciona com qualquer
                                        provedor (Gmail, Outlook, etc).</p>
                                </div>
                            </label>

                            <label
                                class="flex items-center gap-4 p-4 bg-slate-900/50 border border-white/10 rounded-2xl cursor-pointer hover:border-cyan-500/50 transition-all group has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-500/5">
                                <input type="radio" name="send-method" value="graph" class="w-5 h-5 accent-cyan-500">
                                <div>
                                    <p class="font-bold text-white">Microsoft Graph API</p>
                                    <p class="text-xs text-slate-400">Para contas Office 365. Maior entregabilidade via
                                        OAuth.</p>
                                </div>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-slate-400 mb-2">Servidor SMTP</label>
                                <input type="text" id="set-host" placeholder="smtp.office365.com"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                                <p class="text-[10px] text-slate-500 mt-2">Ex: smtp.gmail.com, smtp.office365.com</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-2">Porta</label>
                                <input type="number" id="set-port" placeholder="587"
                                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                                <p class="text-[10px] text-slate-500 mt-2">587 (TLS) ou 465 (SSL)</p>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-900/80 border border-white/5 rounded-xl text-xs text-slate-400">
                            A segurança da conexão é configurada automaticamente: porta <b>465</b> usa SSL direto, porta
                            <b>587</b> usa STARTTLS. Ambas são seguras.
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Senha / Senha de
                                Aplicativo</label>
                            <input type="password" id="set-pass" placeholder="••••••••••••••••"
                                class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 transition-all outline-none">
                            <p class="text-[10px] text-slate-500 mt-2">Use senhas de aplicativo se estiver usando Gmail
                                ou Outlook.</p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="saveConfig()"
                            class="px-8 py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all">Salvar
                            Configuração</button>
                        <button onclick="testSmtp()"
                            class="px-8 py-4 bg-transparent border-2 border-white/20 text-white rounded-xl font-bold hover:bg-white/5 transition-all flex items-center gap-2">
                            <i class="far fa-check-circle"></i> Testar Conexão
                        </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals (Leads, Editor, etc) -->
    <div id="modalOverlay"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
        <div id="modalContent" class="glass w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-y-auto p-8 relative">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-8 right-8 glass p-4 rounded-2xl flex items-center gap-4 transition-all duration-500 translate-y-32 z-[200]">
        <div id="toastIconBg" class="p-2 rounded-lg">
            <i id="toastIcon" class="fas text-sm"></i>
        </div>
        <p id="toastMsg" class="font-semibold text-white"></p>
    </div>

    <script>
        // Core state
        let currentTab = 'dashboard';
        const sections = ['dashboard', 'gallery', 'leads', 'templates', 'campaigns', 'settings'];

        function switchTab(tabId) {
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                const t = document.getElementById(`tab-${s}`);
                if (t) t.classList.remove('active-tab', 'bg-white/5', 'text-cyan-400');
            });

            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) activeTab.classList.add('active-tab');

            currentTab = tabId;

            // Auto refresh content
            if (tabId === 'gallery') loadImages();
            if (tabId === 'leads') loadLeads();
            if (tabId === 'templates') loadTemplates();
            if (tabId === 'campaigns') loadCampaigns();
            if (tabId === 'settings') loadConfig();
            if (tabId === 'dashboard') loadStats();
        }

        // --- Notifications ---
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            const toastIconBg = document.getElementById('toastIconBg');
            const toastIcon = document.getElementById('toastIcon');

            toastMsg.innerText = msg;
            toast.classList.remove('translate-y-32');

            toastIconBg.className = 'p-2 rounded-lg';
            toastIcon.className = 'fas text-sm';

            if (type === 'error') {
                toastIconBg.classList.add('bg-rose-500/20');
                toastIcon.classList.add('fa-times', 'text-rose-400');
            } else if (type === 'info') {
                toastIconBg.classList.add('bg-cyan-500/20');
                toastIcon.classList.add('fa-spinner', 'fa-spin', 'text-cyan-400');
            } else {
                toastIconBg.classList.add('bg-cyan-500/20');
                toastIcon.classList.add('fa-check', 'text-cyan-400');
            }

            setTimeout(() => { toast.classList.add('translate-y-32'); }, 4000);
        }

        // --- Gallery ---
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const images = await response.json();
                const grid = document.getElementById('imageGrid');
                grid.innerHTML = images.map(img => `
                    <div class="glass p-4 rounded-3xl glass-hover group">
                        <div class="aspect-square rounded-2xl overflow-hidden bg-slate-800 mb-4 relative">
                            <img src="${img.url}" class="w-full h-full object-cover">
                            <button onclick="deleteImage('${img.filename}')" class="absolute top-2 right-2 p-2 bg-rose-500/80 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <button onclick="copyToClipboard('${img.url}')" class="w-full py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold hover:bg-cyan-500/10 hover:text-cyan-400 transition-all">
                            Copiar Link Direto
                        </button>
                    </div>
                `).join('');
            } catch (err) { showToast('Erro ao carregar galeria', 'error'); }
        }

        async function deleteImage(filename) {
            if (!confirm('Deletar imagem?')) return;
            try {
                await fetch(`/api/images/${filename}`, { method: 'DELETE' });
                showToast('Imagem removida');
                loadImages();
            } catch (err) { showToast('Falha ao deletar', 'error'); }
        }

        // --- Leads ---
        async function loadLeads() {
            try {
                const response = await fetch('/api/marketing/leads');
                const leads = await response.json();
                const table = document.getElementById('leadsTable');
                table.innerHTML = leads.map(l => `
                    <tr>
                        <td class="px-6 py-4 text-white font-medium">${l.name || 'Sem nome'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${l.email}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${l.telefone || '-'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${l.empresa || '-'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${l.cidade_uf || '-'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${l.cpf_cnpj || '-'}</td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap gap-1">
                                ${l.tags.map(t => `<span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-[10px] font-bold rounded-full">${t}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="deleteLead('${l.id}')" class="text-slate-500 hover:text-rose-400 px-2 transition-all">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8" class="p-12 text-center text-slate-500">Nenhum lead cadastrado ainda.</td></tr>';
            } catch (err) { console.error(err); }
        }

        async function importLeads(input) {
            const formData = new FormData();
            formData.append('file', input.files[0]);
            showToast('Importando...', 'info');
            try {
                const res = await fetch('/api/marketing/leads/import', { method: 'POST', body: formData });
                const result = await res.json();
                showToast(`Sucesso! ${result.imported} novos, ${result.duplicates} duplicados.`);
                loadLeads();
            } catch (err) { showToast('Falha na importação', 'error'); }
            input.value = '';
        }

        async function deleteLead(id) {
            if (!confirm('Remover lead?')) return;
            await fetch(`/api/marketing/leads/${id}`, { method: 'DELETE' });
            loadLeads();
        }

        // --- Templates ---
        async function loadTemplates() {
            try {
                const response = await fetch('/api/marketing/templates');
                const templates = await response.json();
                const grid = document.getElementById('templatesGrid');
                grid.innerHTML = templates.map(t => `
                    <div class="glass p-4 rounded-3xl flex flex-col md:flex-row gap-6 border border-white/5 hover:border-cyan-500/20 transition-all group">
                        <!-- Horizontal Preview -->
                        <div class="w-full md:w-48 lg:w-64 h-32 md:h-auto bg-white rounded-2xl overflow-hidden pointer-events-none relative border border-white/10">
                            <iframe srcdoc="${t.htmlContent.replace(/"/g, '&quot;').replace(/{{name}}/gi, 'Cliente')}" class="w-[1200px] h-[800px] border-0 origin-top-left scale-[0.2]"></iframe>
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-slate-950/20"></div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 flex flex-col justify-between py-1">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h4 class="text-xl font-bold text-white leading-tight">${t.name}</h4>
                                    <div class="flex gap-1">
                                        <button onclick='openTemplateEditor(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="p-2 text-slate-400 hover:text-cyan-400 transition-all">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteTemplate('${t.id}')" class="p-2 text-slate-500 hover:text-rose-400 transition-all opacity-0 group-hover:opacity-100">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-400 mt-1 line-clamp-1">Assunto: ${t.subject}</p>
                            </div>
                            
                            <div class="flex gap-3 mt-4">
                                <button onclick='copyTemplateHtml(${JSON.stringify(t.htmlContent).replace(/'/g, "&apos;")})'
                                    class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold text-slate-300 hover:bg-cyan-500/10 hover:text-cyan-400 transition-all flex items-center gap-2">
                                    <i class="fas fa-code"></i> Copiar HTML
                                </button>
                                <button onclick='openTemplateEditor(${JSON.stringify(t).replace(/'/g, "&apos;")})'
                                    class="px-4 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-xl text-xs font-bold text-cyan-400 hover:bg-cyan-500 hover:text-white transition-all">
                                    Editar Modelo
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<div class="col-span-full p-12 text-center text-slate-500">Nenhum modelo cadastrado.</div>';
            } catch (err) { }
        }

        function openTemplateEditor(template = null) {
            const modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="flex flex-col h-full max-h-[85vh]">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white">${template ? 'Editar Modelo' : 'Novo Modelo'}</h2>
                            <p class="text-xs text-slate-500">${template ? template.name : 'Configuração de layout de email'}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="toggleEditorMode()" id="toggle-editor" class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold text-cyan-400 hover:bg-cyan-500/10 transition-all flex items-center gap-2">
                                <i class="fas fa-eye"></i> Modo Visual
                            </button>
                            <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 overflow-hidden">
                        <!-- Left Panel: Controls/Code -->
                        <div id="editor-left" class="lg:col-span-5 flex flex-col gap-4 overflow-hidden">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Nome do Modelo</label>
                                    <input type="text" id="tpl-name" placeholder="Nome Interno" value="${template ? template.name : ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-2.5 text-white outline-none focus:border-cyan-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Assunto do E-mail</label>
                                    <input type="text" id="tpl-subject" placeholder="Assunto" value="${template ? template.subject : ''}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-2.5 text-white outline-none focus:border-cyan-500">
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col min-h-[300px]">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Código HTML</label>
                                <textarea id="tpl-html" class="flex-1 w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-[11px] font-mono text-cyan-300 outline-none resize-none leading-relaxed" oninput="updatePreview()">${template ? template.htmlContent : '<html><body style="font-family: Arial; padding: 40px; color: #333;"><h1>Olá, {{name}}!</h1><p>Este é o seu novo modelo de email pronto para ser editado.</p></body></html>'}</textarea>
                            </div>
                        </div>

                        <!-- Right Panel: Visual Preview/Edit -->
                        <div class="lg:col-span-7 flex flex-col gap-2 overflow-hidden">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase">Visualização Interativa</label>
                            <div class="flex-1 bg-white rounded-2xl overflow-hidden relative border border-white/10">
                                <iframe id="tpl-preview" class="w-full h-full border-0"></iframe>
                                <div id="visual-overlay" class="absolute inset-0 bg-transparent pointer-events-none border-2 border-cyan-500 hidden opacity-50"></div>
                            </div>
                            <p class="text-[10px] text-slate-500 italic"><i class="fas fa-info-circle mr-1"></i> No modo visual, clique em qualquer texto para editar diretamente.</p>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-4">
                         <button onclick="saveTemplate('${template ? template.id : ''}')" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">Salvar Alterações</button>
                    </div>
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');

            // Wait for iframe to load before applying interactive logic
            setTimeout(() => {
                updatePreview();
                setupVisualEditor();
            }, 100);
        }

        let isVisualMode = false;
        function toggleEditorMode() {
            isVisualMode = !isVisualMode;
            const btn = document.getElementById('toggle-editor');
            const left = document.getElementById('editor-left');

            if (isVisualMode) {
                btn.innerHTML = '<i class="fas fa-code"></i> Modo Código';
                btn.classList.add('bg-cyan-500/10');
                left.classList.add('hidden');
            } else {
                btn.innerHTML = '<i class="fas fa-eye"></i> Modo Visual';
                btn.classList.remove('bg-cyan-500/10');
                left.classList.remove('hidden');
            }
        }

        function setupVisualEditor() {
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;

            doc.addEventListener('click', (e) => {
                if (e.target.tagName !== 'HTML' && e.target.tagName !== 'BODY') {
                    // Make the clicked element editable
                    e.target.contentEditable = "true";
                    e.target.focus();
                }
            });

            doc.addEventListener('input', () => {
                // Sync back to textarea
                const html = doc.documentElement.outerHTML;
                document.getElementById('tpl-html').value = html;
            });

            // Prevent links from navigating inside preview
            doc.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') e.preventDefault();
            }, true);
        }

        function updatePreview() {
            const html = document.getElementById('tpl-html').value;
            const iframe = document.getElementById('tpl-preview');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html.replace(/{{name}}/gi, 'Cliente Exemplo'));
            doc.close();
        }

        function copyTemplateHtml(html) {
            navigator.clipboard.writeText(html).then(() => {
                showToast('HTML copiado para a área de transferência!');
            });
        }

        async function testSmtp() {
            const port = parseInt(document.getElementById('set-port').value);
            const data = {
                senderEmail: document.getElementById('set-email').value,
                senderName: document.getElementById('set-name').value,
                smtpHost: document.getElementById('set-host').value,
                smtpPort: port,
                smtpPassword: document.getElementById('set-pass').value,
                smtpSecure: port === 465
            };

            showToast('Testando conexão...', 'info');
            try {
                const res = await fetch('/api/marketing/config/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Conexão estabelecida com sucesso!');
                } else {
                    showToast('Falha na conexão: ' + result.error, 'error');
                }
            } catch (err) {
                showToast('Erro ao testar SMTP', 'error');
            }
        }

        async function saveTemplate(id) {
            const data = {
                id: id || undefined,
                name: document.getElementById('tpl-name').value,
                subject: document.getElementById('tpl-subject').value,
                htmlContent: document.getElementById('tpl-html').value
            };
            await fetch('/api/marketing/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast('Modelo salvo!');
            closeModal();
            loadTemplates();
        }

        async function uploadTemplate(input) {
            const file = input.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            showToast('Enviando...', 'info');
            try {
                const res = await fetch('/api/marketing/templates/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.id) {
                    showToast('Modelo carregado!');
                    loadTemplates();
                } else {
                    showToast('Erro no upload', 'error');
                }
            } catch (err) { showToast('Erro no servidor', 'error'); }
            input.value = '';
        }

        async function deleteTemplate(id) {
            if (!confirm('Remover modelo?')) return;
            await fetch(`/api/marketing/templates/${id}`, { method: 'DELETE' });
            loadTemplates();
        }

        // --- Campaigns ---
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/marketing/campaigns');
                const campaigns = await response.json();
                const list = document.getElementById('campaignsList');
                list.innerHTML = campaigns.map(c => {
                    const progress = c.totalLeads ? Math.round((c.sentCount / c.totalLeads) * 100) : 0;
                    const statusColors = { 'draft': 'bg-slate-500/20 text-slate-400', 'running': 'bg-cyan-500/20 text-cyan-400', 'completed': 'bg-green-500/20 text-green-400', 'failed': 'bg-rose-500/20 text-rose-400' };
                    return `
                            <div class="glass p-6 rounded-3xl flex flex-col md:flex-row md:items-center justify-between gap-6">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h4 class="text-xl font-bold text-white">${c.name}</h4>
                                        <span class="px-2 py-0.5 rounded-full text-[10px] uppercase font-bold ${statusColors[c.status]}">${c.status}</span>
                                    </div>
                                    <p class="text-sm text-slate-400">Progresso: ${c.sentCount} de ${c.totalLeads || 0} emails</p>
                                    <div class="w-full h-1.5 bg-white/5 rounded-full mt-3 overflow-hidden">
                                        <div class="h-full bg-cyan-500 transition-all duration-1000" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    ${c.status !== 'running' ? `<button onclick="startCampaign('${c.id}')" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-xl text-xs font-bold hover:bg-cyan-500 hover:text-white transition-all">Iniciar</button>` : `<button onclick="stopCampaign('${c.id}')" class="px-4 py-2 bg-rose-500/20 text-rose-400 rounded-xl text-xs font-bold">Parar</button>`}
                                    <button onclick="deleteCampaign('${c.id}')" class="p-2 text-slate-500 hover:text-rose-400 transition-all"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            `;
                }).join('') || '<div class="p-12 text-center text-slate-500">Nenhuma campanha cadastrada.</div>';
            } catch (err) { }
        }

        let wizardState = { step: 1, data: {}, templates: [], leads: [], availableTags: [], selectedTags: [] };

        async function openCampaignWizard() {
            wizardState = { step: 1, data: { batchSize: 50, interval: 60 }, selectedTags: [] };
            wizardState.templates = await (await fetch('/api/marketing/templates')).json();
            wizardState.leads = await (await fetch('/api/marketing/leads')).json();
            wizardState.availableTags = [...new Set(wizardState.leads.flatMap(l => l.tags))];
            renderWizard();
        }

        function renderWizard() {
            const modal = document.getElementById('modalContent');
            const step = wizardState.step;

            let content = '';
            if (step === 1) {
                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">Criar Campanha - Etapa 1 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Nome da Campanha</label>
                            <input type="text" id="wiz-name" value="${wizardState.data.name || ''}" placeholder="Ex: Newsletter Q3" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Assunto do Email</label>
                            <input type="text" id="wiz-subject" value="${wizardState.data.subject || ''}" placeholder="Grandes novidades..." class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Modelo de Email</label>
                            <select id="wiz-template" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                                <option value="">Selecione um modelo</option>
                                ${wizardState.templates.map(t => `<option value="${t.id}" ${wizardState.data.templateId == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="nextWizStep()" class="w-full py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all">Próximo</button>
                    </div>
                `;
            } else if (step === 2) {
                const leadCount = wizardState.selectedTags.length === 0 ? wizardState.leads.length : wizardState.leads.filter(l => l.tags.some(t => wizardState.selectedTags.includes(t))).length;

                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">Criar Campanha - Etapa 2 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">Tags de Destino</label>
                            <p class="text-[10px] text-slate-500 mb-3">Selecione as tags dos leads que receberão esta campanha. Deixe vazio para enviar a todos.</p>
                            
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${wizardState.selectedTags.map(t => `
                                    <span class="flex items-center gap-2 px-3 py-1 bg-cyan-600 text-white rounded-lg text-xs font-bold">
                                        ${t}
                                        <button onclick="removeWizTag('${t}')" class="hover:text-cyan-200"><i class="fas fa-times"></i></button>
                                    </span>
                                `).join('')}
                            </div>

                            <div class="relative">
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"><i class="fas fa-search"></i></div>
                                <input type="text" id="wiz-tag-search" oninput="filterWizTags()" placeholder="Pesquisar tags..." class="w-full bg-slate-900/50 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white outline-none focus:border-cyan-500">
                                <div id="wiz-tag-results" class="absolute top-full left-0 w-full mt-2 bg-slate-800 border border-white/10 rounded-xl overflow-hidden hidden z-50 shadow-2xl">
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-400"><b class="text-cyan-400">${leadCount.toLocaleString()} lead(s)</b> serão incluídos nesta campanha</p>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Tamanho do Lote (emails por lote)</label>
                                <input type="number" id="wiz-batch" value="${wizardState.data.batchSize}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Intervalo (segundos entre lotes)</label>
                                <input type="number" id="wiz-interval" value="${wizardState.data.interval}" class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-cyan-500">
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="prevWizStep()" class="flex-1 py-4 bg-white/5 border border-white/20 text-white rounded-xl font-bold hover:bg-white/10 transition-all">Voltar</button>
                            <button onclick="nextWizStep()" class="flex-1 py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all">Revisar</button>
                        </div>
                    </div>
                `;
            } else if (step === 3) {
                const template = wizardState.templates.find(t => t.id == wizardState.data.templateId);
                const leadCount = wizardState.selectedTags.length === 0 ? wizardState.leads.length : wizardState.leads.filter(l => l.tags.some(t => wizardState.selectedTags.includes(t))).length;

                content = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">Criar Campanha - Etapa 3 de 3</h2>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="glass p-6 rounded-2xl bg-slate-900/50 space-y-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Nome</span>
                            <span class="text-white font-bold">${wizardState.data.name}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Assunto</span>
                            <span class="text-white font-bold">${wizardState.data.subject}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Modelo</span>
                            <span class="text-white font-bold">${template ? template.name : 'N/A'}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Controle de envio</span>
                            <span class="text-white font-bold">${wizardState.data.batchSize} emails a cada ${wizardState.data.interval}s</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Tags de Destino</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${wizardState.selectedTags.length > 0 ? wizardState.selectedTags.map(t => `<span class="px-2 py-0.5 bg-cyan-600 text-white rounded text-[10px] font-bold">${t}</span>`).join('') : '<span class="text-white text-xs">Todos os leads</span>'}
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/10 mt-4 flex justify-between items-end">
                            <div>
                                <span class="text-[10px] font-bold text-slate-500 uppercase">Total de Leads</span>
                                <p class="text-lg text-white font-bold">${leadCount.toLocaleString()} <span class="text-xs text-slate-500 font-normal">destinatários</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="prevWizStep()" class="flex-1 py-4 bg-white/5 border border-white/20 text-white rounded-xl font-bold hover:bg-white/10 transition-all">Voltar</button>
                        <button onclick="saveCampaign()" class="flex-1 py-4 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 transition-all shadow-lg shadow-cyan-600/20">Criar Campanha</button>
                    </div>
                `;
            }

            modal.innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
        }

        function filterWizTags() {
            const query = document.getElementById('wiz-tag-search').value.toLowerCase();
            const resultsDiv = document.getElementById('wiz-tag-results');

            if (!query) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = wizardState.availableTags.filter(t => t.toLowerCase().includes(query) && !wizardState.selectedTags.includes(t));

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div class="p-4 text-slate-500 text-xs">Nenhuma tag encontrada</div>';
            } else {
                resultsDiv.innerHTML = matches.map(t => `
                    <button onclick="addWizTag('${t}')" class="w-full text-left p-3 text-sm text-white hover:bg-cyan-600 transition-all flex justify-between items-center group">
                        ${t}
                        <i class="fas fa-plus text-cyan-500 group-hover:text-white"></i>
                    </button>
                `).join('');
            }
            resultsDiv.classList.remove('hidden');
        }

        function addWizTag(tag) {
            wizardState.selectedTags.push(tag);
            document.getElementById('wiz-tag-search').value = '';
            document.getElementById('wiz-tag-results').classList.add('hidden');
            renderWizard();
        }

        function removeWizTag(tag) {
            wizardState.selectedTags = wizardState.selectedTags.filter(t => t !== tag);
            renderWizard();
        }

        function nextWizStep() {
            if (wizardState.step === 1) {
                wizardState.data.name = document.getElementById('wiz-name').value;
                wizardState.data.subject = document.getElementById('wiz-subject').value;
                wizardState.data.templateId = document.getElementById('wiz-template').value;
                if (!wizardState.data.name || !wizardState.data.templateId) return showToast('Nome e Modelo são obrigatórios', 'error');
            } else if (wizardState.step === 2) {
                wizardState.data.batchSize = parseInt(document.getElementById('wiz-batch').value) || 50;
                wizardState.data.interval = parseInt(document.getElementById('wiz-interval').value) || 60;
            }
            wizardState.step++;
            renderWizard();
        }

        function prevWizStep() {
            wizardState.step--;
            renderWizard();
        }

        async function saveCampaign() {
            const data = {
                name: wizardState.data.name,
                templateId: wizardState.data.templateId,
                subject: wizardState.data.subject,
                targetTags: wizardState.selectedTags,
                status: 'draft',
                batchSize: wizardState.data.batchSize,
                interval: wizardState.data.interval
            };

            showToast('Criando campanha...', 'info');
            await fetch('/api/marketing/campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast('Campanha criada!');
            closeModal();
            loadCampaigns();
        }

        async function startCampaign(id) {
            await fetch(`/api/marketing/campaigns/${id}/start`, { method: 'POST' });
            showToast('Campanha iniciada!', 'info');
            loadCampaigns();
        }

        async function stopCampaign(id) {
            await fetch(`/api/marketing/campaigns/${id}/stop`, { method: 'POST' });
            showToast('Campanha pausada', 'info');
            loadCampaigns();
        }

        async function deleteCampaign(id) {
            if (!confirm('Remover campanha?')) return;
            await fetch(`/api/marketing/campaigns/${id}`, { method: 'DELETE' });
            loadCampaigns();
        }

        // --- Settings ---
        async function loadConfig() {
            try {
                const config = await (await fetch('/api/marketing/config')).json();
                document.getElementById('set-email').value = config.senderEmail || '';
                document.getElementById('set-name').value = config.senderName || '';
                document.getElementById('set-host').value = config.smtpHost || '';
                document.getElementById('set-port').value = config.smtpPort || '';
                document.getElementById('set-pass').value = config.smtpPassword || '';
            } catch (err) { }
        }

        async function saveConfig() {
            const port = parseInt(document.getElementById('set-port').value);
            const data = {
                senderEmail: document.getElementById('set-email').value,
                senderName: document.getElementById('set-name').value,
                smtpHost: document.getElementById('set-host').value,
                smtpPort: port,
                smtpPassword: document.getElementById('set-pass').value,
                smtpSecure: port === 465
            };
            await fetch('/api/marketing/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast('Configurações salvas!');
        }

        // --- Stats ---
        async function loadStats() {
            try {
                const leads = await (await fetch('/api/marketing/leads')).json();
                const images = await (await fetch('/api/images')).json();
                const campaigns = await (await fetch('/api/marketing/campaigns')).json();

                document.getElementById('stat-leads').innerText = leads.length;
                document.getElementById('stat-images').innerText = images.length;
                document.getElementById('stat-active-camp').innerText = campaigns.filter(c => c.status === 'running').length;

                let totalSent = 0;
                campaigns.forEach(c => totalSent += (c.sentCount || 0));
                document.getElementById('stat-sent').innerText = totalSent;
            } catch (err) { }
        }

        // --- Utils ---
        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById('modalOverlay').classList.remove('flex');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Link copiado para o email!');
            });
        }

        // Init
        // Refresh stats periodically
        setInterval(loadStats, 10000);
        loadStats();

        // Drag & Drop for Gallery
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('image', file);
            showToast('Enviando...', 'info');
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    showToast('Sucesso!');
                    loadImages();
                }
            } catch (err) { showToast('Erro no upload', 'error'); }
            fileInput.value = '';
        });

    </script>
</body>

</html>